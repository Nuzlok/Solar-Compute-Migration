<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.1.0"/>
    <title>migrator_v2 API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#NodeState">NodeState</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#NodeState.IDLE">IDLE</a>
                        </li>
                        <li>
                                <a class="variable" href="#NodeState.BUSY">BUSY</a>
                        </li>
                        <li>
                                <a class="variable" href="#NodeState.MIGRATING">MIGRATING</a>
                        </li>
                        <li>
                                <a class="variable" href="#NodeState.SHUTDOWN">SHUTDOWN</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ProcessState">ProcessState</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#ProcessState.RUNNING">RUNNING</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessState.WAITING">WAITING</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessState.TERMINATED">TERMINATED</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessState.DUMPED">DUMPED</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessState.COMPLETED">COMPLETED</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessState.ERROR">ERROR</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessState.NONE">NONE</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Process">Process</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Process.__init__">Process</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.getProcessName">getProcessName</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.getDirectory">getDirectory</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.terminate">terminate</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.start">start</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.restore">restore</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.dump">dump</a>
                        </li>
                        <li>
                                <a class="function" href="#Process.deleteFromDisk">deleteFromDisk</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#isLossOfPower">isLossOfPower</a>
            </li>
            <li>
                    <a class="function" href="#getMigrateCMD">getMigrateCMD</a>
            </li>
            <li>
                    <a class="function" href="#sendFinishFlag">sendFinishFlag</a>
            </li>
            <li>
                    <a class="function" href="#getNewProcess">getNewProcess</a>
            </li>
            <li>
                    <a class="function" href="#checkpointAndMigrateProcessToNode">checkpointAndMigrateProcessToNode</a>
            </li>
            <li>
                    <a class="function" href="#rsyncProcessToNode">rsyncProcessToNode</a>
            </li>
            <li>
                    <a class="function" href="#IPalias">IPalias</a>
            </li>
            <li>
                    <a class="function" href="#findAvailableNode">findAvailableNode</a>
            </li>
            <li>
                    <a class="function" href="#confirmNodeAvailable">confirmNodeAvailable</a>
            </li>
            <li>
                    <a class="function" href="#MainFSM">MainFSM</a>
            </li>
            <li>
                    <a class="function" href="#main">main</a>
            </li>
            <li>
                    <a class="class" href="#BroadcastSender">BroadcastSender</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BroadcastSender.__init__">BroadcastSender</a>
                        </li>
                        <li>
                                <a class="function" href="#BroadcastSender.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#BroadcastSender.stop">stop</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BroadcastReceiver">BroadcastReceiver</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BroadcastReceiver.__init__">BroadcastReceiver</a>
                        </li>
                        <li>
                                <a class="function" href="#BroadcastReceiver.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#BroadcastReceiver.stop">stop</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
migrator_v2    </h1>

                
                        <input id="mod-migrator_v2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-migrator_v2-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">random</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">socket</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">threading</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="n">IPv4Address</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span> <span class="nn">netifaces</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">pexpect</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">mean</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="c1"># import RPi.GPIO  # ensure pin factory is set to RPi.GPIO</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="c1"># import spidev  # only for gpio pins on raspberry pi</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="c1"># from gpiozero import MCP3008, LEDBoard, PWMLED</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="k">class</span> <span class="nc">NodeState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="n">IDLE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>			<span class="c1"># Node is idle and ready to accept</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>    <span class="n">BUSY</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>			<span class="c1"># Node is busy with processes and cannot accept processes</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>    <span class="n">MIGRATING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  	<span class="c1"># Node is migrating to another and cannot accept processes</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>    <span class="n">SHUTDOWN</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>		<span class="c1"># Node is shutting down and cannot accept processes</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="k">class</span> <span class="nc">ProcessState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">RUNNING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># Process is running</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">WAITING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># Process is waiting to be started</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="n">TERMINATED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># Process is terminated forcefully</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="n">DUMPED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>      <span class="c1"># Process is dumped</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>   <span class="c1"># Process is completed successfully</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">ERROR</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>		 <span class="c1"># Process is terminated due to an error</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">NONE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>		 <span class="c1"># There is no process</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="c1"># FIXME some of the state variables are not used. Remove them</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="n">selfState</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;online&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;voltage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;migrate_cmd&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reboot_cmd&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;shutdown_cmd&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="n">uniqueOtherNodeStatuses</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># set of unique statuses from other nodes (all nodes except this one). key is IP address, value is status</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="n">DIRECTORY</span> <span class="o">=</span> <span class="s2">&quot;/home/pi/ReceivedProcesses/&quot;</span>  <span class="c1"># directory to store processes that are received from other nodes (Currently not used)</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="n">ADC_Values</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">5</span>  <span class="c1"># Store ADC values to smooth  using a moving average</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="c1"># led_4 = PWMLED(4)  # LED on pin 4 (These LEDs are to show the status of the node during Expo)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="c1"># led_17 = PWMLED(17)  # LED on pin 17</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="c1"># led_27 = PWMLED(27)  # LED on pin 27</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="c1"># led_22 = PWMLED(22)  # LED on pin 22</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="k">class</span> <span class="nc">Process</span><span class="p">:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    Contains all the information about a process and provides functions to start, stop, and terminate the process.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    TODO: convert to a dataclass instead of a normal class. This will make the code more readable and easier to use</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aliasIP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">NONE</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procName</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasIP</span> <span class="o">=</span> <span class="n">aliasIP</span>  <span class="c1"># getAvailableIP()  # TODO: get an available IP address for the process (check list of used IPs and invert that list)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Process: &lt;Name:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">procName</span><span class="si">}</span><span class="s2">, Location:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">, PID:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">, IP:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aliasIP</span><span class="si">}</span><span class="s2">, State:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">procState</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="k">def</span> <span class="nf">getProcessName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the process. This is the name of the executable, not the PID or anything else&quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">procName</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="k">def</span> <span class="nf">getDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the directory of the process. returns None if process does not have a directory&quot;&quot;&quot;</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminate the process. returns True if successful&quot;&quot;&quot;</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo kill -9 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">TERMINATED</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Check if the process is a new process or a dumped process. If it is a new process, run it. If it is a dumped process, restore it. &quot;&quot;&quot;</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/home/pi/cpflag.txt&quot;</span><span class="p">):</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;restoring process&quot;</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running new process&quot;</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a new process. returns True if successful&quot;&quot;&quot;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setsid nohup sudo python3 /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s2"> --bind_ip 192.168.137.3 &lt;/dev/null &amp;&gt;/dev/null &amp;&quot;</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait for the process to start before getting the PID</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;pgrep&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Get the PID of the process</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/pi&#39;</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="c1"># self.pid = os.spawnlp(os.P_NOWAIT, &#39;python3&#39;, &#39;python3&#39;, f&#39;/home/pi/{procname}/{execName}&#39;, f&#39;--bind_ip={self.aliasIP}&#39;)  # Get the PID of the process</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="c1"># if self.pid != &quot;&quot;:  # If the PID is not empty</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="c1">#     self.procState = ProcessState.RUNNING</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="c1">#     print(f&quot;Created {self}&quot;)  # self has a __str__ method that prints the process name and PID</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="c1">#     return True</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="c1"># return False</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;-vvvv&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;restore.log&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tcp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Start an existing dumped process. return True if successful. &quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">IPalias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;192.168.137.3&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;setsid nohup unshare sudo criu restore -vvvv -o restore.log --shell-job --tcp-established &amp;&quot;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 0 means success</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="c1"># TODO: get the PID of the process after it is restored (Does not work for unknown reason)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="c1"># time.sleep(10)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="c1"># result = subprocess.run([&#39;ps&#39;, &#39;ax&#39;], stdout=subprocess.PIPE).stdout</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="c1"># result = subprocess.run([&#39;grep&#39;, f&#39;{execName}&#39;], input=result, stdout=subprocess.PIPE).stdout.decode().split()[0]  # TODO: use the arbitrary process name instead of hardcoding it</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="c1"># self.pid = result</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">RUNNING</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="c1"># TODO: get the PID of the process after it is restored</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># If the PID is not empty</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restoring </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># self has a __str__ method that prints the process name and PID</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">RUNNING</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;-vvvv&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;output.log&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tcp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Dump the process using CRIU. Accepts a command to run after the dump is complete. returns True if successful. &quot;&quot;&quot;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="c1"># Delete any preexisting dump files in the directory (This is to prevent multiple dumps files interfeering)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf core* fs* ids* invent* mm-* pagemap* pages* pstree* seccomp* stats* tcp* timens* tty* files* fdinfo* nohup.out dump.log restore.log flag.txt&quot;</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dumping </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># TODO: use the arbitrary process name instead of hardcoding it, also use grep instead of this (try os.popen(&#39;ps ax | grep {process_name}&#39;))</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">matching_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">matching_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo criu dump -vvvv -o dump.log -t </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> --shell-job --tcp-established --ghost-limit 100000000 &amp;&amp; echo OK&quot;</span><span class="p">)</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/pi&#39;</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo rm -rf cpflag.txt </span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/cpflag.txt /home/pi/cpflag.txt startflag.txt </span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/startflag.txt /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">DUMPED</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="c1"># if os.system(f&quot;pgrep -f {execName}&quot;) != 0:</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="c1">#     return False</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="c1"># self.procState = ProcessState.DUMPED</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="c1"># return True</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">deleteFromDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="c1"># return os.system(f&quot;rm -rf {self.getDirectory()}&quot;) == 0</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="k">def</span> <span class="nf">isLossOfPower</span><span class="p">(</span><span class="n">vThresh</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">vScale</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span> <span class="n">cScale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Decide when node is losing power by comparing the voltage and current to a threshold. &quot;&quot;&quot;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="c1"># get the rolling average of the last 5 values</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    <span class="n">ADC_Values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">voltage</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">vScale</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">cScale</span><span class="p">))</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>    <span class="n">ADC_Values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>    <span class="n">vol</span><span class="p">,</span> <span class="n">curr</span> <span class="o">=</span> <span class="n">mean</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ADC_Values</span><span class="p">]),</span> <span class="n">mean</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ADC_Values</span><span class="p">])</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>    <span class="k">return</span> <span class="n">vol</span> <span class="o">&lt;</span> <span class="n">vThresh</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="k">def</span> <span class="nf">getMigrateCMD</span><span class="p">(</span><span class="n">forceMigrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">    Handle migrate command. Returns true when the process should be migrated.</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">    Migration is triggered by a loss of power or a manual migate command through the HMI.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">    forceMigrate parameter is there for testing purposes, and in case there is a future need to force a migration.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    <span class="k">global</span> <span class="n">selfState</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="k">if</span> <span class="n">isLossOfPower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">forceMigrate</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;migrate_cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;migrate_cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/home/pi/force_migrate.txt&quot;</span><span class="p">):</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf /home/pi/force_migrate.txt&quot;</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="k">def</span> <span class="nf">sendFinishFlag</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">    Send a flag to the destination node to indicate that the file transfer is complete.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">    without this flag, the destination node will not know if an error occurred during the transfer.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>    <span class="n">ssh_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;sudo scp /home/pi/cpflag.txt </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">:/home/pi/&#39;</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ssh_cmd</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>    <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&#39;s password: &quot;</span><span class="p">])</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/cpflag.txt /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>    <span class="k">return</span> <span class="n">child</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="k">def</span> <span class="nf">getNewProcess</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Process</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">    Check specified directory for files of a process with finish flag.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">    if files are found with the flag, create a process object and return it.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="c1"># global DIRECTORY # Not sure if I need this or not.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>    <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>    <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># TODO: change this to the directory that the process files are stored in using the commented out code below</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/startflag.txt&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/cpflag.txt&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># dont need to look for the folder, we can check for the flag directly</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flag File Found, creating process&quot;</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>    <span class="k">return</span> <span class="n">Process</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">aliasIP</span><span class="o">=</span><span class="n">IPv4Address</span><span class="p">(</span><span class="s2">&quot;192.168.137.3&quot;</span><span class="p">))</span>  <span class="c1"># TODO: change the IP address to a new IP for the process</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>    <span class="c1"># # received is the name of the directory that contains the process files</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>    <span class="c1"># received = next(iter(os.listdir(DIRECTORY)), None) # this will return the first item in the list, or None if the list is empty</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>    <span class="c1"># if received == None: return None</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="c1"># if os.path.exists(os.path.join(DIRECTORY + received, &quot;FLAG.TXT&quot;)) == False: return None</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    <span class="c1"># return Process(received)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="k">def</span> <span class="nf">checkpointAndMigrateProcessToNode</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">Process</span><span class="p">,</span> <span class="n">receivingIP</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">):</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">    Handle checkpointing and migration</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">    1. Checkpoint process</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">    2. confirm node is available and ready to receive process</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">    3. remove IP alias from current node</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">    4. rsync process directory to receiving node</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">    5. Send finish flag to node</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">    6. Delete process and supporting files on current node</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">    7. Display message with timing information for each step as a bar graph</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>    <span class="n">start_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to checkpoint process, dumping failed&quot;</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process dumped successfully&quot;</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>    <span class="n">dump_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>    <span class="c1"># if confirmNodeAvailable(receivingIP) == False:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>    <span class="c1">#     raise Exception(&quot;Receiving node is not responding/available&quot;)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="c1"># print(f&quot;Confirmed node at {receivingIP} is available&quot;)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>    <span class="c1"># confirm_time_ms = int(time.time()*1000)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="k">if</span> <span class="n">IPalias</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">aliasIP</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to remove IP alias from current node, new node will not be able to run process&quot;</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IP alias removed from current node&quot;</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>    <span class="n">alias_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>    <span class="k">if</span> <span class="n">receivingIP</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>    <span class="k">if</span> <span class="n">rsyncProcessToNode</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">receivingIP</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to rsync process to receiving node, process may be incomplete&quot;</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process rsynced to receiving node&quot;</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>    <span class="n">rsync_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>    <span class="k">if</span> <span class="n">sendFinishFlag</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">receivingIP</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">procName</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to send finish flag to receiving node, process may be incomplete&quot;</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish flag sent to receiving node&quot;</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="n">flag_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">deleteFromDisk</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to delete process from disk, process might accidentally be run again&quot;</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process deleted from disk&quot;</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>    <span class="n">delete_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>    <span class="n">bar_width</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>    <span class="n">total_time_ms</span> <span class="o">=</span> <span class="n">delete_time_ms</span><span class="o">-</span><span class="n">start_time_ms</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/migrate_stats.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migration took total of </span><span class="si">{</span><span class="n">total_time_ms</span><span class="si">}</span><span class="s2"> ms</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Dumping&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dump_time_ms</span><span class="o">-</span><span class="n">start_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">dump_time_ms</span><span class="o">-</span><span class="n">start_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;IP alias (rem)&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">alias_time_ms</span><span class="o">-</span><span class="n">dump_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">alias_time_ms</span><span class="o">-</span><span class="n">dump_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Rsyncing&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rsync_time_ms</span><span class="o">-</span><span class="n">alias_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">rsync_time_ms</span><span class="o">-</span><span class="n">alias_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Finish flag&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">flag_time_ms</span><span class="o">-</span><span class="n">rsync_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">flag_time_ms</span><span class="o">-</span><span class="n">rsync_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Deleting&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">delete_time_ms</span><span class="o">-</span><span class="n">flag_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">delete_time_ms</span><span class="o">-</span><span class="n">flag_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>    <span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># remove the process from memory after it has been migrated</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="k">def</span> <span class="nf">rsyncProcessToNode</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">Process</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">):</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;rsync/scp dumped files to receiving node&quot;&quot;&quot;</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="c1"># spawn rsync -avz /home/pi/{proc.getDirectory()} pi@{ip}:{DIRECTORY}</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>    <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    <span class="n">ssh_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;sudo scp -r /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">:/home/pi/&#39;</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>    <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&#39;s password: &quot;</span><span class="p">])</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>    <span class="k">return</span> <span class="n">child</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="c1"># def IPalias(address: IPv4Address, add: bool) -&gt; bool:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="c1">#     &quot;&quot;&quot;Handle IP alias to current node. set add to true to add alias, and vice versa&quot;&quot;&quot;</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="c1">#     global selfState</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="c1">#     if add:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="c1">#         if selfState[&quot;ip_alias&quot;] == None:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="c1">#             selfState[&quot;ip_alias&quot;] = [address]</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="c1">#         else:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="c1">#             selfState[&quot;ip_alias&quot;].append(address)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="c1">#         return os.system(f&quot;ip addr add {address}/24 dev eth0&quot;) == 0</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="c1">#     else:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="c1">#         selfState[&quot;ip_alias&quot;].remove(address)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="c1">#         return os.system(f&quot;ip addr del {address}/24 dev eth0&quot;) == 0</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="k">def</span> <span class="nf">IPalias</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">add</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle IP alias to current node. set add to true to add alias, and vice versa&quot;&quot;&quot;</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>    <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ip addr add </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">/24 dev eth0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ip addr del </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">/24 dev eth0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="k">def</span> <span class="nf">findAvailableNode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">IPv4Address</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find an available node to migrate to&quot;&quot;&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>    <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>    <span class="k">for</span> <span class="n">packet</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">uniqueOtherNodeStatuses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="k">if</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>  <span class="c1"># found an available node</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="n">available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">])</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>    <span class="c1"># TODO: Possible comparison for other factors like time, weather, etc.. here. For now, just return the first available node</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">available</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="k">def</span> <span class="nf">confirmNodeAvailable</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Confirm that the node is available to receive a process by waiting for a new packet from the node&quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    <span class="n">last_time</span> <span class="o">=</span> <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">last_time</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># wait maximum 10 seconds for a new packet from the node</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="k">if</span> <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">last_time</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># timed out</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="k">def</span> <span class="nf">MainFSM</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">Process</span><span class="p">):</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="k">global</span> <span class="n">selfState</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># make sure it doesnt hog the CPU</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>    <span class="k">if</span> <span class="n">useADC</span><span class="p">:</span> 
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="n">voltage</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="si">:</span><span class="s2">=.5f</span><span class="si">}</span><span class="s2">, state=</span><span class="si">{</span><span class="n">selfState</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Press Ctrl-C to exit&quot;</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ADC READING DISABLED, state=</span><span class="si">{</span><span class="n">selfState</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Press Ctrl-C to exit&quot;</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>    <span class="c1"># ------------------ Change State ------------------</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="k">if</span> <span class="n">isLossOfPower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">getMigrateCMD</span><span class="p">():</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">MIGRATING</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="k">elif</span> <span class="n">isLossOfPower</span><span class="p">(</span><span class="n">vThresh</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="c1"># ------------------ Change LEDs ------------------</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>    
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">BUSY</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">MIGRATING</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>    
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="c1"># TODO: improve the logic here, it is a bit messy. maybe use draw a state diagram to help visualize it</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>    <span class="c1"># ------------------ Execute State ------------------</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="n">process</span> <span class="o">=</span> <span class="n">getNewProcess</span><span class="p">()</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="n">IPalias</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">aliasIP</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to start process thread. Process not started.&quot;</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">BUSY</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/home/pi/force_shutdown.txt&quot;</span><span class="p">):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/force_shutdown.txt&quot;</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">BUSY</span><span class="p">:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">procState</span> <span class="o">==</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="c1"># sendProcessResultsToUser() # TODO: if we want to send the results back to the user, we can do that here</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">MIGRATING</span><span class="p">:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="n">checkpointAndMigrateProcessToNode</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">findAvailableNode</span><span class="p">())</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/home/pi/force_idle.txt&quot;</span><span class="p">):</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/force_idle.txt&quot;</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>    <span class="k">return</span> <span class="n">process</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>    <span class="k">global</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">selfState</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>    <span class="c1"># get the ip address of the current host and store it in the selfState dictionary</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="s1">&#39;eth0&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="c1"># https://gpiozero.readthedocs.io/en/stable/api_input.html#mcp3008</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="n">voltage</span> <span class="o">=</span> <span class="n">MCP3008</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">differential</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_voltage</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># single ended on channel 2</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="n">current</span> <span class="o">=</span> <span class="n">MCP3008</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">differential</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_voltage</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># differential on channel 1 and 0, might need to change to pin 0 if output is inverted</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">broadcaster</span> <span class="o">=</span> <span class="n">BroadcastSender</span><span class="p">()</span>  <span class="c1"># Start broadcast sender and receiver threads</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="n">broadcaster</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="n">BroadcastReceiver</span><span class="p">()</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="n">receiver</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading voltage from pin 2, current from pin 0-1&quot;</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">MainFSM</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>  <span class="c1"># Main FSM</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>        <span class="n">broadcaster</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="n">broadcaster</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="n">receiver</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="n">receiver</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="c1"># for alias in selfState[&quot;ip_alias&quot;]:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="c1">#     IPalias(alias, False)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting...&quot;</span><span class="p">)</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="k">class</span> <span class="nc">BroadcastSender</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">    This class is used to create a thread that sends broadcast packets to other nodes. </span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">    The packets contain the node&#39;s current state and IP address.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">12345</span><span class="p">):</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_delay</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">baddress</span> <span class="o">=</span> <span class="n">address</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="k">global</span> <span class="n">selfState</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="c1"># ran = random.randrange(139, 143, 1)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="c1"># selfState[&quot;ip&quot;] = f&quot;192.168.137.{ran}&quot;  # this is temporary for testing. will be replaced with actual ip when we have a network-------------</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voltage</span><span class="o">.</span><span class="n">value</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">value</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selfState</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baddress</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_delay</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="c1"># print(f&quot;broadcasting state {selfState[&#39;ip&#39;]}&quot;)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closing Socket!&quot;</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopped Broadcast!&quot;</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a><span class="k">class</span> <span class="nc">BroadcastReceiver</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This class is used to listen for incoming broadcast status packets from the nodes so each node can know the status of the other nodes&quot;&quot;&quot;</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">listenPort</span> <span class="o">=</span> <span class="mi">12345</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sockSize</span> <span class="o">=</span> <span class="mi">512</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Set a timeout so the socket doesn&#39;t block indefinitely when trying to receive data</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listenPort</span><span class="p">))</span>  <span class="c1"># Listen on all interfaces on port 12345 for broadcast packets</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span> <span class="o">=</span> <span class="mi">8</span>         <span class="c1"># every 8 timeouts, clear the dictionary to remove old nodes</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="k">global</span> <span class="n">uniqueOtherNodeStatuses</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>                <span class="n">packet</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockSize</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>                <span class="k">if</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]:</span>                              <span class="c1"># If the packet is not from this node</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                    <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>  <span class="c1"># TODO: This timout does not work since the socket will receive its own broadcast packets</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                    <span class="n">uniqueOtherNodeStatuses</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># If we don&#39;t receive anything within a period, clear</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>                    <span class="c1"># If we receive any exception, just print it and continue</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  <span class="c1"># if we are running in the main context</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="k">global</span> <span class="n">useADC</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="n">useADC</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    <span class="k">if</span> <span class="s1">&#39;noadc&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ADC disabled&quot;</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">useADC</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="n">voltage</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="n">main</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="NodeState">
                            <input id="NodeState-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NodeState</span><wbr>(<span class="base">enum.Enum</span>):

                <label class="view-source-button" for="NodeState-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NodeState"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NodeState-20"><a href="#NodeState-20"><span class="linenos">20</span></a><span class="k">class</span> <span class="nc">NodeState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="NodeState-21"><a href="#NodeState-21"><span class="linenos">21</span></a>    <span class="n">IDLE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>			<span class="c1"># Node is idle and ready to accept</span>
</span><span id="NodeState-22"><a href="#NodeState-22"><span class="linenos">22</span></a>    <span class="n">BUSY</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>			<span class="c1"># Node is busy with processes and cannot accept processes</span>
</span><span id="NodeState-23"><a href="#NodeState-23"><span class="linenos">23</span></a>    <span class="n">MIGRATING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  	<span class="c1"># Node is migrating to another and cannot accept processes</span>
</span><span id="NodeState-24"><a href="#NodeState-24"><span class="linenos">24</span></a>    <span class="n">SHUTDOWN</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>		<span class="c1"># Node is shutting down and cannot accept processes</span>
</span><span id="NodeState-25"><a href="#NodeState-25"><span class="linenos">25</span></a>
</span><span id="NodeState-26"><a href="#NodeState-26"><span class="linenos">26</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NodeState-27"><a href="#NodeState-27"><span class="linenos">27</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</span></pre></div>


            <div class="docstring"><p>Create a collection of name/value pairs.</p>

<p>Example enumeration:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Color</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">RED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">... </span>    <span class="n">BLUE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="gp">... </span>    <span class="n">GREEN</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre>
</div>

<p>Access them by:</p>

<ul>
<li>attribute access::</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Color</span><span class="o">.</span><span class="n">RED</span>
<span class="go">&lt;Color.RED: 1&gt;</span>
</code></pre>
</div>

<ul>
<li>value lookup:</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Color</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">&lt;Color.RED: 1&gt;</span>
</code></pre>
</div>

<ul>
<li>name lookup:</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Color</span><span class="p">[</span><span class="s1">&#39;RED&#39;</span><span class="p">]</span>
<span class="go">&lt;Color.RED: 1&gt;</span>
</code></pre>
</div>

<p>Enumerations can be iterated over, and know how many members they have:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">Color</span><span class="p">)</span>
<span class="go">3</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">Color</span><span class="p">)</span>
<span class="go">[&lt;Color.RED: 1&gt;, &lt;Color.BLUE: 2&gt;, &lt;Color.GREEN: 3&gt;]</span>
</code></pre>
</div>

<p>Methods can be added to enumerations, and members can have their own
attributes -- see the documentation for details.</p>
</div>


                            <div id="NodeState.IDLE" class="classattr">
                                <div class="attr variable">
            <span class="name">IDLE</span>        =
<span class="default_value">&lt;<a href="#NodeState.IDLE">NodeState.IDLE</a>: 1&gt;</span>

        
    </div>
    <a class="headerlink" href="#NodeState.IDLE"></a>
    
    

                            </div>
                            <div id="NodeState.BUSY" class="classattr">
                                <div class="attr variable">
            <span class="name">BUSY</span>        =
<span class="default_value">&lt;<a href="#NodeState.BUSY">NodeState.BUSY</a>: 2&gt;</span>

        
    </div>
    <a class="headerlink" href="#NodeState.BUSY"></a>
    
    

                            </div>
                            <div id="NodeState.MIGRATING" class="classattr">
                                <div class="attr variable">
            <span class="name">MIGRATING</span>        =
<span class="default_value">&lt;<a href="#NodeState.MIGRATING">NodeState.MIGRATING</a>: 3&gt;</span>

        
    </div>
    <a class="headerlink" href="#NodeState.MIGRATING"></a>
    
    

                            </div>
                            <div id="NodeState.SHUTDOWN" class="classattr">
                                <div class="attr variable">
            <span class="name">SHUTDOWN</span>        =
<span class="default_value">&lt;<a href="#NodeState.SHUTDOWN">NodeState.SHUTDOWN</a>: 4&gt;</span>

        
    </div>
    <a class="headerlink" href="#NodeState.SHUTDOWN"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="NodeState.name" class="variable">name</dd>
                <dd id="NodeState.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ProcessState">
                            <input id="ProcessState-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ProcessState</span><wbr>(<span class="base">enum.Enum</span>):

                <label class="view-source-button" for="ProcessState-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessState"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessState-30"><a href="#ProcessState-30"><span class="linenos">30</span></a><span class="k">class</span> <span class="nc">ProcessState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="ProcessState-31"><a href="#ProcessState-31"><span class="linenos">31</span></a>    <span class="n">RUNNING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># Process is running</span>
</span><span id="ProcessState-32"><a href="#ProcessState-32"><span class="linenos">32</span></a>    <span class="n">WAITING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># Process is waiting to be started</span>
</span><span id="ProcessState-33"><a href="#ProcessState-33"><span class="linenos">33</span></a>    <span class="n">TERMINATED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>  <span class="c1"># Process is terminated forcefully</span>
</span><span id="ProcessState-34"><a href="#ProcessState-34"><span class="linenos">34</span></a>    <span class="n">DUMPED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>      <span class="c1"># Process is dumped</span>
</span><span id="ProcessState-35"><a href="#ProcessState-35"><span class="linenos">35</span></a>    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>   <span class="c1"># Process is completed successfully</span>
</span><span id="ProcessState-36"><a href="#ProcessState-36"><span class="linenos">36</span></a>    <span class="n">ERROR</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>		 <span class="c1"># Process is terminated due to an error</span>
</span><span id="ProcessState-37"><a href="#ProcessState-37"><span class="linenos">37</span></a>    <span class="n">NONE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>		 <span class="c1"># There is no process</span>
</span><span id="ProcessState-38"><a href="#ProcessState-38"><span class="linenos">38</span></a>
</span><span id="ProcessState-39"><a href="#ProcessState-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessState-40"><a href="#ProcessState-40"><span class="linenos">40</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</span></pre></div>


            <div class="docstring"><p>Create a collection of name/value pairs.</p>

<p>Example enumeration:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Color</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">RED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">... </span>    <span class="n">BLUE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="gp">... </span>    <span class="n">GREEN</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre>
</div>

<p>Access them by:</p>

<ul>
<li>attribute access::</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Color</span><span class="o">.</span><span class="n">RED</span>
<span class="go">&lt;Color.RED: 1&gt;</span>
</code></pre>
</div>

<ul>
<li>value lookup:</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Color</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">&lt;Color.RED: 1&gt;</span>
</code></pre>
</div>

<ul>
<li>name lookup:</li>
</ul>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Color</span><span class="p">[</span><span class="s1">&#39;RED&#39;</span><span class="p">]</span>
<span class="go">&lt;Color.RED: 1&gt;</span>
</code></pre>
</div>

<p>Enumerations can be iterated over, and know how many members they have:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">Color</span><span class="p">)</span>
<span class="go">3</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">Color</span><span class="p">)</span>
<span class="go">[&lt;Color.RED: 1&gt;, &lt;Color.BLUE: 2&gt;, &lt;Color.GREEN: 3&gt;]</span>
</code></pre>
</div>

<p>Methods can be added to enumerations, and members can have their own
attributes -- see the documentation for details.</p>
</div>


                            <div id="ProcessState.RUNNING" class="classattr">
                                <div class="attr variable">
            <span class="name">RUNNING</span>        =
<span class="default_value">&lt;<a href="#ProcessState.RUNNING">ProcessState.RUNNING</a>: 1&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.RUNNING"></a>
    
    

                            </div>
                            <div id="ProcessState.WAITING" class="classattr">
                                <div class="attr variable">
            <span class="name">WAITING</span>        =
<span class="default_value">&lt;<a href="#ProcessState.WAITING">ProcessState.WAITING</a>: 2&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.WAITING"></a>
    
    

                            </div>
                            <div id="ProcessState.TERMINATED" class="classattr">
                                <div class="attr variable">
            <span class="name">TERMINATED</span>        =
<span class="default_value">&lt;<a href="#ProcessState.TERMINATED">ProcessState.TERMINATED</a>: 3&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.TERMINATED"></a>
    
    

                            </div>
                            <div id="ProcessState.DUMPED" class="classattr">
                                <div class="attr variable">
            <span class="name">DUMPED</span>        =
<span class="default_value">&lt;<a href="#ProcessState.DUMPED">ProcessState.DUMPED</a>: 4&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.DUMPED"></a>
    
    

                            </div>
                            <div id="ProcessState.COMPLETED" class="classattr">
                                <div class="attr variable">
            <span class="name">COMPLETED</span>        =
<span class="default_value">&lt;<a href="#ProcessState.COMPLETED">ProcessState.COMPLETED</a>: 5&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.COMPLETED"></a>
    
    

                            </div>
                            <div id="ProcessState.ERROR" class="classattr">
                                <div class="attr variable">
            <span class="name">ERROR</span>        =
<span class="default_value">&lt;<a href="#ProcessState.ERROR">ProcessState.ERROR</a>: 6&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.ERROR"></a>
    
    

                            </div>
                            <div id="ProcessState.NONE" class="classattr">
                                <div class="attr variable">
            <span class="name">NONE</span>        =
<span class="default_value">&lt;<a href="#ProcessState.NONE">ProcessState.NONE</a>: 7&gt;</span>

        
    </div>
    <a class="headerlink" href="#ProcessState.NONE"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="ProcessState.name" class="variable">name</dd>
                <dd id="ProcessState.value" class="variable">value</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Process">
                            <input id="Process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Process</span>:

                <label class="view-source-button" for="Process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process-52"><a href="#Process-52"><span class="linenos"> 52</span></a><span class="k">class</span> <span class="nc">Process</span><span class="p">:</span>
</span><span id="Process-53"><a href="#Process-53"><span class="linenos"> 53</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Process-54"><a href="#Process-54"><span class="linenos"> 54</span></a><span class="sd">    Contains all the information about a process and provides functions to start, stop, and terminate the process.</span>
</span><span id="Process-55"><a href="#Process-55"><span class="linenos"> 55</span></a><span class="sd">    TODO: convert to a dataclass instead of a normal class. This will make the code more readable and easier to use</span>
</span><span id="Process-56"><a href="#Process-56"><span class="linenos"> 56</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Process-57"><a href="#Process-57"><span class="linenos"> 57</span></a>
</span><span id="Process-58"><a href="#Process-58"><span class="linenos"> 58</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aliasIP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Process-59"><a href="#Process-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">NONE</span>
</span><span id="Process-60"><a href="#Process-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procName</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Process-61"><a href="#Process-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
</span><span id="Process-62"><a href="#Process-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasIP</span> <span class="o">=</span> <span class="n">aliasIP</span>  <span class="c1"># getAvailableIP()  # TODO: get an available IP address for the process (check list of used IPs and invert that list)</span>
</span><span id="Process-63"><a href="#Process-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Process-64"><a href="#Process-64"><span class="linenos"> 64</span></a>
</span><span id="Process-65"><a href="#Process-65"><span class="linenos"> 65</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Process-66"><a href="#Process-66"><span class="linenos"> 66</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Process: &lt;Name:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">procName</span><span class="si">}</span><span class="s2">, Location:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">, PID:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">, IP:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aliasIP</span><span class="si">}</span><span class="s2">, State:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">procState</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
</span><span id="Process-67"><a href="#Process-67"><span class="linenos"> 67</span></a>
</span><span id="Process-68"><a href="#Process-68"><span class="linenos"> 68</span></a>    <span class="k">def</span> <span class="nf">getProcessName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Process-69"><a href="#Process-69"><span class="linenos"> 69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the process. This is the name of the executable, not the PID or anything else&quot;&quot;&quot;</span>
</span><span id="Process-70"><a href="#Process-70"><span class="linenos"> 70</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">procName</span>
</span><span id="Process-71"><a href="#Process-71"><span class="linenos"> 71</span></a>
</span><span id="Process-72"><a href="#Process-72"><span class="linenos"> 72</span></a>    <span class="k">def</span> <span class="nf">getDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Process-73"><a href="#Process-73"><span class="linenos"> 73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the directory of the process. returns None if process does not have a directory&quot;&quot;&quot;</span>
</span><span id="Process-74"><a href="#Process-74"><span class="linenos"> 74</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
</span><span id="Process-75"><a href="#Process-75"><span class="linenos"> 75</span></a>
</span><span id="Process-76"><a href="#Process-76"><span class="linenos"> 76</span></a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process-77"><a href="#Process-77"><span class="linenos"> 77</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminate the process. returns True if successful&quot;&quot;&quot;</span>
</span><span id="Process-78"><a href="#Process-78"><span class="linenos"> 78</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo kill -9 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Process-79"><a href="#Process-79"><span class="linenos"> 79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">TERMINATED</span>
</span><span id="Process-80"><a href="#Process-80"><span class="linenos"> 80</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process-81"><a href="#Process-81"><span class="linenos"> 81</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Process-82"><a href="#Process-82"><span class="linenos"> 82</span></a>
</span><span id="Process-83"><a href="#Process-83"><span class="linenos"> 83</span></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process-84"><a href="#Process-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Check if the process is a new process or a dumped process. If it is a new process, run it. If it is a dumped process, restore it. &quot;&quot;&quot;</span>
</span><span id="Process-85"><a href="#Process-85"><span class="linenos"> 85</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/home/pi/cpflag.txt&quot;</span><span class="p">):</span>
</span><span id="Process-86"><a href="#Process-86"><span class="linenos"> 86</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;restoring process&quot;</span><span class="p">)</span>
</span><span id="Process-87"><a href="#Process-87"><span class="linenos"> 87</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="Process-88"><a href="#Process-88"><span class="linenos"> 88</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
</span><span id="Process-89"><a href="#Process-89"><span class="linenos"> 89</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Process-90"><a href="#Process-90"><span class="linenos"> 90</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running new process&quot;</span><span class="p">)</span>
</span><span id="Process-91"><a href="#Process-91"><span class="linenos"> 91</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="Process-92"><a href="#Process-92"><span class="linenos"> 92</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="Process-93"><a href="#Process-93"><span class="linenos"> 93</span></a>
</span><span id="Process-94"><a href="#Process-94"><span class="linenos"> 94</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process-95"><a href="#Process-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a new process. returns True if successful&quot;&quot;&quot;</span>
</span><span id="Process-96"><a href="#Process-96"><span class="linenos"> 96</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process-97"><a href="#Process-97"><span class="linenos"> 97</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="Process-98"><a href="#Process-98"><span class="linenos"> 98</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process-99"><a href="#Process-99"><span class="linenos"> 99</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setsid nohup sudo python3 /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s2"> --bind_ip 192.168.137.3 &lt;/dev/null &amp;&gt;/dev/null &amp;&quot;</span><span class="p">)</span>
</span><span id="Process-100"><a href="#Process-100"><span class="linenos">100</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait for the process to start before getting the PID</span>
</span><span id="Process-101"><a href="#Process-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;pgrep&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Get the PID of the process</span>
</span><span id="Process-102"><a href="#Process-102"><span class="linenos">102</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Process-103"><a href="#Process-103"><span class="linenos">103</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/pi&#39;</span><span class="p">)</span>
</span><span id="Process-104"><a href="#Process-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Process-105"><a href="#Process-105"><span class="linenos">105</span></a>
</span><span id="Process-106"><a href="#Process-106"><span class="linenos">106</span></a>        <span class="c1"># self.pid = os.spawnlp(os.P_NOWAIT, &#39;python3&#39;, &#39;python3&#39;, f&#39;/home/pi/{procname}/{execName}&#39;, f&#39;--bind_ip={self.aliasIP}&#39;)  # Get the PID of the process</span>
</span><span id="Process-107"><a href="#Process-107"><span class="linenos">107</span></a>        <span class="c1"># if self.pid != &quot;&quot;:  # If the PID is not empty</span>
</span><span id="Process-108"><a href="#Process-108"><span class="linenos">108</span></a>        <span class="c1">#     self.procState = ProcessState.RUNNING</span>
</span><span id="Process-109"><a href="#Process-109"><span class="linenos">109</span></a>        <span class="c1">#     print(f&quot;Created {self}&quot;)  # self has a __str__ method that prints the process name and PID</span>
</span><span id="Process-110"><a href="#Process-110"><span class="linenos">110</span></a>        <span class="c1">#     return True</span>
</span><span id="Process-111"><a href="#Process-111"><span class="linenos">111</span></a>        <span class="c1"># return False</span>
</span><span id="Process-112"><a href="#Process-112"><span class="linenos">112</span></a>
</span><span id="Process-113"><a href="#Process-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;-vvvv&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;restore.log&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tcp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process-114"><a href="#Process-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Start an existing dumped process. return True if successful. &quot;&quot;&quot;</span>
</span><span id="Process-115"><a href="#Process-115"><span class="linenos">115</span></a>
</span><span id="Process-116"><a href="#Process-116"><span class="linenos">116</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process-117"><a href="#Process-117"><span class="linenos">117</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="Process-118"><a href="#Process-118"><span class="linenos">118</span></a>        <span class="n">IPalias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;192.168.137.3&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Process-119"><a href="#Process-119"><span class="linenos">119</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process-120"><a href="#Process-120"><span class="linenos">120</span></a>        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;setsid nohup unshare sudo criu restore -vvvv -o restore.log --shell-job --tcp-established &amp;&quot;</span>
</span><span id="Process-121"><a href="#Process-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 0 means success</span>
</span><span id="Process-122"><a href="#Process-122"><span class="linenos">122</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Process-123"><a href="#Process-123"><span class="linenos">123</span></a>
</span><span id="Process-124"><a href="#Process-124"><span class="linenos">124</span></a>        <span class="c1"># TODO: get the PID of the process after it is restored (Does not work for unknown reason)</span>
</span><span id="Process-125"><a href="#Process-125"><span class="linenos">125</span></a>        <span class="c1"># time.sleep(10)</span>
</span><span id="Process-126"><a href="#Process-126"><span class="linenos">126</span></a>        <span class="c1"># result = subprocess.run([&#39;ps&#39;, &#39;ax&#39;], stdout=subprocess.PIPE).stdout</span>
</span><span id="Process-127"><a href="#Process-127"><span class="linenos">127</span></a>        <span class="c1"># result = subprocess.run([&#39;grep&#39;, f&#39;{execName}&#39;], input=result, stdout=subprocess.PIPE).stdout.decode().split()[0]  # TODO: use the arbitrary process name instead of hardcoding it</span>
</span><span id="Process-128"><a href="#Process-128"><span class="linenos">128</span></a>        <span class="c1"># self.pid = result</span>
</span><span id="Process-129"><a href="#Process-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">RUNNING</span>
</span><span id="Process-130"><a href="#Process-130"><span class="linenos">130</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process-131"><a href="#Process-131"><span class="linenos">131</span></a>
</span><span id="Process-132"><a href="#Process-132"><span class="linenos">132</span></a>        <span class="c1"># TODO: get the PID of the process after it is restored</span>
</span><span id="Process-133"><a href="#Process-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># If the PID is not empty</span>
</span><span id="Process-134"><a href="#Process-134"><span class="linenos">134</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restoring </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># self has a __str__ method that prints the process name and PID</span>
</span><span id="Process-135"><a href="#Process-135"><span class="linenos">135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">RUNNING</span>
</span><span id="Process-136"><a href="#Process-136"><span class="linenos">136</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process-137"><a href="#Process-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Process-138"><a href="#Process-138"><span class="linenos">138</span></a>
</span><span id="Process-139"><a href="#Process-139"><span class="linenos">139</span></a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;-vvvv&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;output.log&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tcp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process-140"><a href="#Process-140"><span class="linenos">140</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Dump the process using CRIU. Accepts a command to run after the dump is complete. returns True if successful. &quot;&quot;&quot;</span>
</span><span id="Process-141"><a href="#Process-141"><span class="linenos">141</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process-142"><a href="#Process-142"><span class="linenos">142</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="Process-143"><a href="#Process-143"><span class="linenos">143</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process-144"><a href="#Process-144"><span class="linenos">144</span></a>
</span><span id="Process-145"><a href="#Process-145"><span class="linenos">145</span></a>        <span class="c1"># Delete any preexisting dump files in the directory (This is to prevent multiple dumps files interfeering)</span>
</span><span id="Process-146"><a href="#Process-146"><span class="linenos">146</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf core* fs* ids* invent* mm-* pagemap* pages* pstree* seccomp* stats* tcp* timens* tty* files* fdinfo* nohup.out dump.log restore.log flag.txt&quot;</span><span class="p">)</span>
</span><span id="Process-147"><a href="#Process-147"><span class="linenos">147</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dumping </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Process-148"><a href="#Process-148"><span class="linenos">148</span></a>
</span><span id="Process-149"><a href="#Process-149"><span class="linenos">149</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="Process-150"><a href="#Process-150"><span class="linenos">150</span></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># TODO: use the arbitrary process name instead of hardcoding it, also use grep instead of this (try os.popen(&#39;ps ax | grep {process_name}&#39;))</span>
</span><span id="Process-151"><a href="#Process-151"><span class="linenos">151</span></a>        <span class="n">matching_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
</span><span id="Process-152"><a href="#Process-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">matching_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Process-153"><a href="#Process-153"><span class="linenos">153</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process-154"><a href="#Process-154"><span class="linenos">154</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo criu dump -vvvv -o dump.log -t </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> --shell-job --tcp-established --ghost-limit 100000000 &amp;&amp; echo OK&quot;</span><span class="p">)</span>
</span><span id="Process-155"><a href="#Process-155"><span class="linenos">155</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="Process-156"><a href="#Process-156"><span class="linenos">156</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/pi&#39;</span><span class="p">)</span>
</span><span id="Process-157"><a href="#Process-157"><span class="linenos">157</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo rm -rf cpflag.txt </span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/cpflag.txt /home/pi/cpflag.txt startflag.txt </span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/startflag.txt /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="Process-158"><a href="#Process-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">DUMPED</span>
</span><span id="Process-159"><a href="#Process-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process-160"><a href="#Process-160"><span class="linenos">160</span></a>
</span><span id="Process-161"><a href="#Process-161"><span class="linenos">161</span></a>        <span class="c1"># if os.system(f&quot;pgrep -f {execName}&quot;) != 0:</span>
</span><span id="Process-162"><a href="#Process-162"><span class="linenos">162</span></a>        <span class="c1">#     return False</span>
</span><span id="Process-163"><a href="#Process-163"><span class="linenos">163</span></a>        <span class="c1"># self.procState = ProcessState.DUMPED</span>
</span><span id="Process-164"><a href="#Process-164"><span class="linenos">164</span></a>        <span class="c1"># return True</span>
</span><span id="Process-165"><a href="#Process-165"><span class="linenos">165</span></a>
</span><span id="Process-166"><a href="#Process-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">deleteFromDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process-167"><a href="#Process-167"><span class="linenos">167</span></a>        <span class="c1"># return os.system(f&quot;rm -rf {self.getDirectory()}&quot;) == 0</span>
</span><span id="Process-168"><a href="#Process-168"><span class="linenos">168</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process-169"><a href="#Process-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Contains all the information about a process and provides functions to start, stop, and terminate the process.
TODO: convert to a dataclass instead of a normal class. This will make the code more readable and easier to use</p>
</div>


                            <div id="Process.__init__" class="classattr">
                                        <input id="Process.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">location</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">aliasIP</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Process.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.__init__-58"><a href="#Process.__init__-58"><span class="linenos">58</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aliasIP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Process.__init__-59"><a href="#Process.__init__-59"><span class="linenos">59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">NONE</span>
</span><span id="Process.__init__-60"><a href="#Process.__init__-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procName</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Process.__init__-61"><a href="#Process.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
</span><span id="Process.__init__-62"><a href="#Process.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasIP</span> <span class="o">=</span> <span class="n">aliasIP</span>  <span class="c1"># getAvailableIP()  # TODO: get an available IP address for the process (check list of used IPs and invert that list)</span>
</span><span id="Process.__init__-63"><a href="#Process.__init__-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Process.getProcessName" class="classattr">
                                        <input id="Process.getProcessName-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getProcessName</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Process.getProcessName-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.getProcessName"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.getProcessName-68"><a href="#Process.getProcessName-68"><span class="linenos">68</span></a>    <span class="k">def</span> <span class="nf">getProcessName</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Process.getProcessName-69"><a href="#Process.getProcessName-69"><span class="linenos">69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the process. This is the name of the executable, not the PID or anything else&quot;&quot;&quot;</span>
</span><span id="Process.getProcessName-70"><a href="#Process.getProcessName-70"><span class="linenos">70</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">procName</span>
</span></pre></div>


            <div class="docstring"><p>Get the name of the process. This is the name of the executable, not the PID or anything else</p>
</div>


                            </div>
                            <div id="Process.getDirectory" class="classattr">
                                        <input id="Process.getDirectory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getDirectory</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Process.getDirectory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.getDirectory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.getDirectory-72"><a href="#Process.getDirectory-72"><span class="linenos">72</span></a>    <span class="k">def</span> <span class="nf">getDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Process.getDirectory-73"><a href="#Process.getDirectory-73"><span class="linenos">73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the directory of the process. returns None if process does not have a directory&quot;&quot;&quot;</span>
</span><span id="Process.getDirectory-74"><a href="#Process.getDirectory-74"><span class="linenos">74</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
</span></pre></div>


            <div class="docstring"><p>Get the directory of the process. returns None if process does not have a directory</p>
</div>


                            </div>
                            <div id="Process.terminate" class="classattr">
                                        <input id="Process.terminate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">terminate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Process.terminate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.terminate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.terminate-76"><a href="#Process.terminate-76"><span class="linenos">76</span></a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process.terminate-77"><a href="#Process.terminate-77"><span class="linenos">77</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminate the process. returns True if successful&quot;&quot;&quot;</span>
</span><span id="Process.terminate-78"><a href="#Process.terminate-78"><span class="linenos">78</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo kill -9 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Process.terminate-79"><a href="#Process.terminate-79"><span class="linenos">79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">TERMINATED</span>
</span><span id="Process.terminate-80"><a href="#Process.terminate-80"><span class="linenos">80</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process.terminate-81"><a href="#Process.terminate-81"><span class="linenos">81</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Terminate the process. returns True if successful</p>
</div>


                            </div>
                            <div id="Process.start" class="classattr">
                                        <input id="Process.start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Process.start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.start-83"><a href="#Process.start-83"><span class="linenos">83</span></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process.start-84"><a href="#Process.start-84"><span class="linenos">84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Check if the process is a new process or a dumped process. If it is a new process, run it. If it is a dumped process, restore it. &quot;&quot;&quot;</span>
</span><span id="Process.start-85"><a href="#Process.start-85"><span class="linenos">85</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/home/pi/cpflag.txt&quot;</span><span class="p">):</span>
</span><span id="Process.start-86"><a href="#Process.start-86"><span class="linenos">86</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;restoring process&quot;</span><span class="p">)</span>
</span><span id="Process.start-87"><a href="#Process.start-87"><span class="linenos">87</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="Process.start-88"><a href="#Process.start-88"><span class="linenos">88</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
</span><span id="Process.start-89"><a href="#Process.start-89"><span class="linenos">89</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Process.start-90"><a href="#Process.start-90"><span class="linenos">90</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running new process&quot;</span><span class="p">)</span>
</span><span id="Process.start-91"><a href="#Process.start-91"><span class="linenos">91</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="Process.start-92"><a href="#Process.start-92"><span class="linenos">92</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Check if the process is a new process or a dumped process. If it is a new process, run it. If it is a dumped process, restore it.</p>
</div>


                            </div>
                            <div id="Process.run" class="classattr">
                                        <input id="Process.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">command</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Process.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.run-94"><a href="#Process.run-94"><span class="linenos"> 94</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process.run-95"><a href="#Process.run-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a new process. returns True if successful&quot;&quot;&quot;</span>
</span><span id="Process.run-96"><a href="#Process.run-96"><span class="linenos"> 96</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process.run-97"><a href="#Process.run-97"><span class="linenos"> 97</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="Process.run-98"><a href="#Process.run-98"><span class="linenos"> 98</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process.run-99"><a href="#Process.run-99"><span class="linenos"> 99</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setsid nohup sudo python3 /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s2"> --bind_ip 192.168.137.3 &lt;/dev/null &amp;&gt;/dev/null &amp;&quot;</span><span class="p">)</span>
</span><span id="Process.run-100"><a href="#Process.run-100"><span class="linenos">100</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait for the process to start before getting the PID</span>
</span><span id="Process.run-101"><a href="#Process.run-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;pgrep&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Get the PID of the process</span>
</span><span id="Process.run-102"><a href="#Process.run-102"><span class="linenos">102</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Process.run-103"><a href="#Process.run-103"><span class="linenos">103</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/pi&#39;</span><span class="p">)</span>
</span><span id="Process.run-104"><a href="#Process.run-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Process.run-105"><a href="#Process.run-105"><span class="linenos">105</span></a>
</span><span id="Process.run-106"><a href="#Process.run-106"><span class="linenos">106</span></a>        <span class="c1"># self.pid = os.spawnlp(os.P_NOWAIT, &#39;python3&#39;, &#39;python3&#39;, f&#39;/home/pi/{procname}/{execName}&#39;, f&#39;--bind_ip={self.aliasIP}&#39;)  # Get the PID of the process</span>
</span><span id="Process.run-107"><a href="#Process.run-107"><span class="linenos">107</span></a>        <span class="c1"># if self.pid != &quot;&quot;:  # If the PID is not empty</span>
</span><span id="Process.run-108"><a href="#Process.run-108"><span class="linenos">108</span></a>        <span class="c1">#     self.procState = ProcessState.RUNNING</span>
</span><span id="Process.run-109"><a href="#Process.run-109"><span class="linenos">109</span></a>        <span class="c1">#     print(f&quot;Created {self}&quot;)  # self has a __str__ method that prints the process name and PID</span>
</span><span id="Process.run-110"><a href="#Process.run-110"><span class="linenos">110</span></a>        <span class="c1">#     return True</span>
</span><span id="Process.run-111"><a href="#Process.run-111"><span class="linenos">111</span></a>        <span class="c1"># return False</span>
</span></pre></div>


            <div class="docstring"><p>Start a new process. returns True if successful</p>
</div>


                            </div>
                            <div id="Process.restore" class="classattr">
                                        <input id="Process.restore-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">restore</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;-vvvv&#39;</span>,</span><span class="param">	<span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;restore.log&#39;</span>,</span><span class="param">	<span class="n">shell</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">tcp</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Process.restore-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.restore"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.restore-113"><a href="#Process.restore-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;-vvvv&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;restore.log&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tcp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process.restore-114"><a href="#Process.restore-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Start an existing dumped process. return True if successful. &quot;&quot;&quot;</span>
</span><span id="Process.restore-115"><a href="#Process.restore-115"><span class="linenos">115</span></a>
</span><span id="Process.restore-116"><a href="#Process.restore-116"><span class="linenos">116</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process.restore-117"><a href="#Process.restore-117"><span class="linenos">117</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="Process.restore-118"><a href="#Process.restore-118"><span class="linenos">118</span></a>        <span class="n">IPalias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;192.168.137.3&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Process.restore-119"><a href="#Process.restore-119"><span class="linenos">119</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process.restore-120"><a href="#Process.restore-120"><span class="linenos">120</span></a>        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;setsid nohup unshare sudo criu restore -vvvv -o restore.log --shell-job --tcp-established &amp;&quot;</span>
</span><span id="Process.restore-121"><a href="#Process.restore-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 0 means success</span>
</span><span id="Process.restore-122"><a href="#Process.restore-122"><span class="linenos">122</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Process.restore-123"><a href="#Process.restore-123"><span class="linenos">123</span></a>
</span><span id="Process.restore-124"><a href="#Process.restore-124"><span class="linenos">124</span></a>        <span class="c1"># TODO: get the PID of the process after it is restored (Does not work for unknown reason)</span>
</span><span id="Process.restore-125"><a href="#Process.restore-125"><span class="linenos">125</span></a>        <span class="c1"># time.sleep(10)</span>
</span><span id="Process.restore-126"><a href="#Process.restore-126"><span class="linenos">126</span></a>        <span class="c1"># result = subprocess.run([&#39;ps&#39;, &#39;ax&#39;], stdout=subprocess.PIPE).stdout</span>
</span><span id="Process.restore-127"><a href="#Process.restore-127"><span class="linenos">127</span></a>        <span class="c1"># result = subprocess.run([&#39;grep&#39;, f&#39;{execName}&#39;], input=result, stdout=subprocess.PIPE).stdout.decode().split()[0]  # TODO: use the arbitrary process name instead of hardcoding it</span>
</span><span id="Process.restore-128"><a href="#Process.restore-128"><span class="linenos">128</span></a>        <span class="c1"># self.pid = result</span>
</span><span id="Process.restore-129"><a href="#Process.restore-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">RUNNING</span>
</span><span id="Process.restore-130"><a href="#Process.restore-130"><span class="linenos">130</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process.restore-131"><a href="#Process.restore-131"><span class="linenos">131</span></a>
</span><span id="Process.restore-132"><a href="#Process.restore-132"><span class="linenos">132</span></a>        <span class="c1"># TODO: get the PID of the process after it is restored</span>
</span><span id="Process.restore-133"><a href="#Process.restore-133"><span class="linenos">133</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># If the PID is not empty</span>
</span><span id="Process.restore-134"><a href="#Process.restore-134"><span class="linenos">134</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restoring </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># self has a __str__ method that prints the process name and PID</span>
</span><span id="Process.restore-135"><a href="#Process.restore-135"><span class="linenos">135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">RUNNING</span>
</span><span id="Process.restore-136"><a href="#Process.restore-136"><span class="linenos">136</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process.restore-137"><a href="#Process.restore-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Start an existing dumped process. return True if successful.</p>
</div>


                            </div>
                            <div id="Process.dump" class="classattr">
                                        <input id="Process.dump-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dump</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;-vvvv&#39;</span>,</span><span class="param">	<span class="n">log_file</span><span class="o">=</span><span class="s1">&#39;output.log&#39;</span>,</span><span class="param">	<span class="n">shell</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">tcp</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Process.dump-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.dump"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.dump-139"><a href="#Process.dump-139"><span class="linenos">139</span></a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;-vvvv&quot;</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;output.log&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tcp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process.dump-140"><a href="#Process.dump-140"><span class="linenos">140</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Dump the process using CRIU. Accepts a command to run after the dump is complete. returns True if successful. &quot;&quot;&quot;</span>
</span><span id="Process.dump-141"><a href="#Process.dump-141"><span class="linenos">141</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process.dump-142"><a href="#Process.dump-142"><span class="linenos">142</span></a>        <span class="n">execName</span> <span class="o">=</span> <span class="s2">&quot;vidboardmain.py&quot;</span>
</span><span id="Process.dump-143"><a href="#Process.dump-143"><span class="linenos">143</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process.dump-144"><a href="#Process.dump-144"><span class="linenos">144</span></a>
</span><span id="Process.dump-145"><a href="#Process.dump-145"><span class="linenos">145</span></a>        <span class="c1"># Delete any preexisting dump files in the directory (This is to prevent multiple dumps files interfeering)</span>
</span><span id="Process.dump-146"><a href="#Process.dump-146"><span class="linenos">146</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf core* fs* ids* invent* mm-* pagemap* pages* pstree* seccomp* stats* tcp* timens* tty* files* fdinfo* nohup.out dump.log restore.log flag.txt&quot;</span><span class="p">)</span>
</span><span id="Process.dump-147"><a href="#Process.dump-147"><span class="linenos">147</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dumping </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Process.dump-148"><a href="#Process.dump-148"><span class="linenos">148</span></a>
</span><span id="Process.dump-149"><a href="#Process.dump-149"><span class="linenos">149</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;ax&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="Process.dump-150"><a href="#Process.dump-150"><span class="linenos">150</span></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># TODO: use the arbitrary process name instead of hardcoding it, also use grep instead of this (try os.popen(&#39;ps ax | grep {process_name}&#39;))</span>
</span><span id="Process.dump-151"><a href="#Process.dump-151"><span class="linenos">151</span></a>        <span class="n">matching_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">execName</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
</span><span id="Process.dump-152"><a href="#Process.dump-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">matching_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Process.dump-153"><a href="#Process.dump-153"><span class="linenos">153</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Process.dump-154"><a href="#Process.dump-154"><span class="linenos">154</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo criu dump -vvvv -o dump.log -t </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2"> --shell-job --tcp-established --ghost-limit 100000000 &amp;&amp; echo OK&quot;</span><span class="p">)</span>
</span><span id="Process.dump-155"><a href="#Process.dump-155"><span class="linenos">155</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="Process.dump-156"><a href="#Process.dump-156"><span class="linenos">156</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/pi&#39;</span><span class="p">)</span>
</span><span id="Process.dump-157"><a href="#Process.dump-157"><span class="linenos">157</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sudo rm -rf cpflag.txt </span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/cpflag.txt /home/pi/cpflag.txt startflag.txt </span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">/startflag.txt /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="Process.dump-158"><a href="#Process.dump-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procState</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">DUMPED</span>
</span><span id="Process.dump-159"><a href="#Process.dump-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Process.dump-160"><a href="#Process.dump-160"><span class="linenos">160</span></a>
</span><span id="Process.dump-161"><a href="#Process.dump-161"><span class="linenos">161</span></a>        <span class="c1"># if os.system(f&quot;pgrep -f {execName}&quot;) != 0:</span>
</span><span id="Process.dump-162"><a href="#Process.dump-162"><span class="linenos">162</span></a>        <span class="c1">#     return False</span>
</span><span id="Process.dump-163"><a href="#Process.dump-163"><span class="linenos">163</span></a>        <span class="c1"># self.procState = ProcessState.DUMPED</span>
</span><span id="Process.dump-164"><a href="#Process.dump-164"><span class="linenos">164</span></a>        <span class="c1"># return True</span>
</span></pre></div>


            <div class="docstring"><p>Dump the process using CRIU. Accepts a command to run after the dump is complete. returns True if successful.</p>
</div>


                            </div>
                            <div id="Process.deleteFromDisk" class="classattr">
                                        <input id="Process.deleteFromDisk-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">deleteFromDisk</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Process.deleteFromDisk-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Process.deleteFromDisk"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Process.deleteFromDisk-166"><a href="#Process.deleteFromDisk-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">deleteFromDisk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Process.deleteFromDisk-167"><a href="#Process.deleteFromDisk-167"><span class="linenos">167</span></a>        <span class="c1"># return os.system(f&quot;rm -rf {self.getDirectory()}&quot;) == 0</span>
</span><span id="Process.deleteFromDisk-168"><a href="#Process.deleteFromDisk-168"><span class="linenos">168</span></a>        <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="Process.deleteFromDisk-169"><a href="#Process.deleteFromDisk-169"><span class="linenos">169</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="isLossOfPower">
                            <input id="isLossOfPower-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">isLossOfPower</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">vThresh</span><span class="o">=</span><span class="mi">12</span>, </span><span class="param"><span class="n">vScale</span><span class="o">=</span><span class="mi">55</span>, </span><span class="param"><span class="n">cScale</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="isLossOfPower-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#isLossOfPower"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="isLossOfPower-172"><a href="#isLossOfPower-172"><span class="linenos">172</span></a><span class="k">def</span> <span class="nf">isLossOfPower</span><span class="p">(</span><span class="n">vThresh</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">vScale</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span> <span class="n">cScale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="isLossOfPower-173"><a href="#isLossOfPower-173"><span class="linenos">173</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Decide when node is losing power by comparing the voltage and current to a threshold. &quot;&quot;&quot;</span>
</span><span id="isLossOfPower-174"><a href="#isLossOfPower-174"><span class="linenos">174</span></a>    <span class="c1"># get the rolling average of the last 5 values</span>
</span><span id="isLossOfPower-175"><a href="#isLossOfPower-175"><span class="linenos">175</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="isLossOfPower-176"><a href="#isLossOfPower-176"><span class="linenos">176</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="isLossOfPower-177"><a href="#isLossOfPower-177"><span class="linenos">177</span></a>    <span class="n">ADC_Values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">voltage</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">vScale</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">cScale</span><span class="p">))</span>
</span><span id="isLossOfPower-178"><a href="#isLossOfPower-178"><span class="linenos">178</span></a>    <span class="n">ADC_Values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="isLossOfPower-179"><a href="#isLossOfPower-179"><span class="linenos">179</span></a>    <span class="n">vol</span><span class="p">,</span> <span class="n">curr</span> <span class="o">=</span> <span class="n">mean</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ADC_Values</span><span class="p">]),</span> <span class="n">mean</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ADC_Values</span><span class="p">])</span>
</span><span id="isLossOfPower-180"><a href="#isLossOfPower-180"><span class="linenos">180</span></a>    <span class="k">return</span> <span class="n">vol</span> <span class="o">&lt;</span> <span class="n">vThresh</span>
</span></pre></div>


            <div class="docstring"><p>Decide when node is losing power by comparing the voltage and current to a threshold.</p>
</div>


                </section>
                <section id="getMigrateCMD">
                            <input id="getMigrateCMD-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getMigrateCMD</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">forceMigrate</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="getMigrateCMD-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#getMigrateCMD"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="getMigrateCMD-183"><a href="#getMigrateCMD-183"><span class="linenos">183</span></a><span class="k">def</span> <span class="nf">getMigrateCMD</span><span class="p">(</span><span class="n">forceMigrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="getMigrateCMD-184"><a href="#getMigrateCMD-184"><span class="linenos">184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="getMigrateCMD-185"><a href="#getMigrateCMD-185"><span class="linenos">185</span></a><span class="sd">    Handle migrate command. Returns true when the process should be migrated.</span>
</span><span id="getMigrateCMD-186"><a href="#getMigrateCMD-186"><span class="linenos">186</span></a><span class="sd">    Migration is triggered by a loss of power or a manual migate command through the HMI.</span>
</span><span id="getMigrateCMD-187"><a href="#getMigrateCMD-187"><span class="linenos">187</span></a><span class="sd">    forceMigrate parameter is there for testing purposes, and in case there is a future need to force a migration.</span>
</span><span id="getMigrateCMD-188"><a href="#getMigrateCMD-188"><span class="linenos">188</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="getMigrateCMD-189"><a href="#getMigrateCMD-189"><span class="linenos">189</span></a>    <span class="k">global</span> <span class="n">selfState</span>
</span><span id="getMigrateCMD-190"><a href="#getMigrateCMD-190"><span class="linenos">190</span></a>    <span class="k">if</span> <span class="n">isLossOfPower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">forceMigrate</span><span class="p">:</span>
</span><span id="getMigrateCMD-191"><a href="#getMigrateCMD-191"><span class="linenos">191</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="getMigrateCMD-192"><a href="#getMigrateCMD-192"><span class="linenos">192</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;migrate_cmd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="getMigrateCMD-193"><a href="#getMigrateCMD-193"><span class="linenos">193</span></a>        <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;migrate_cmd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="getMigrateCMD-194"><a href="#getMigrateCMD-194"><span class="linenos">194</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="getMigrateCMD-195"><a href="#getMigrateCMD-195"><span class="linenos">195</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/home/pi/force_migrate.txt&quot;</span><span class="p">):</span>
</span><span id="getMigrateCMD-196"><a href="#getMigrateCMD-196"><span class="linenos">196</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf /home/pi/force_migrate.txt&quot;</span><span class="p">)</span>
</span><span id="getMigrateCMD-197"><a href="#getMigrateCMD-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="getMigrateCMD-198"><a href="#getMigrateCMD-198"><span class="linenos">198</span></a>    <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Handle migrate command. Returns true when the process should be migrated.
Migration is triggered by a loss of power or a manual migate command through the HMI.
forceMigrate parameter is there for testing purposes, and in case there is a future need to force a migration.</p>
</div>


                </section>
                <section id="sendFinishFlag">
                            <input id="sendFinishFlag-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sendFinishFlag</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">ip</span><span class="p">:</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span>,</span><span class="param">	<span class="n">username</span><span class="o">=</span><span class="s1">&#39;pi&#39;</span>,</span><span class="param">	<span class="n">password</span><span class="o">=</span><span class="s1">&#39;pi&#39;</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="sendFinishFlag-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#sendFinishFlag"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="sendFinishFlag-201"><a href="#sendFinishFlag-201"><span class="linenos">201</span></a><span class="k">def</span> <span class="nf">sendFinishFlag</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="sendFinishFlag-202"><a href="#sendFinishFlag-202"><span class="linenos">202</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="sendFinishFlag-203"><a href="#sendFinishFlag-203"><span class="linenos">203</span></a><span class="sd">    Send a flag to the destination node to indicate that the file transfer is complete.</span>
</span><span id="sendFinishFlag-204"><a href="#sendFinishFlag-204"><span class="linenos">204</span></a><span class="sd">    without this flag, the destination node will not know if an error occurred during the transfer.</span>
</span><span id="sendFinishFlag-205"><a href="#sendFinishFlag-205"><span class="linenos">205</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="sendFinishFlag-206"><a href="#sendFinishFlag-206"><span class="linenos">206</span></a>
</span><span id="sendFinishFlag-207"><a href="#sendFinishFlag-207"><span class="linenos">207</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="sendFinishFlag-208"><a href="#sendFinishFlag-208"><span class="linenos">208</span></a>    <span class="n">ssh_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;sudo scp /home/pi/cpflag.txt </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">:/home/pi/&#39;</span>
</span><span id="sendFinishFlag-209"><a href="#sendFinishFlag-209"><span class="linenos">209</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ssh_cmd</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="sendFinishFlag-210"><a href="#sendFinishFlag-210"><span class="linenos">210</span></a>    <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="sendFinishFlag-211"><a href="#sendFinishFlag-211"><span class="linenos">211</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&#39;s password: &quot;</span><span class="p">])</span>
</span><span id="sendFinishFlag-212"><a href="#sendFinishFlag-212"><span class="linenos">212</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="sendFinishFlag-213"><a href="#sendFinishFlag-213"><span class="linenos">213</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
</span><span id="sendFinishFlag-214"><a href="#sendFinishFlag-214"><span class="linenos">214</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="sendFinishFlag-215"><a href="#sendFinishFlag-215"><span class="linenos">215</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/cpflag.txt /home/pi/startflag.txt&quot;</span><span class="p">)</span>
</span><span id="sendFinishFlag-216"><a href="#sendFinishFlag-216"><span class="linenos">216</span></a>    <span class="k">return</span> <span class="n">child</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Send a flag to the destination node to indicate that the file transfer is complete.
without this flag, the destination node will not know if an error occurred during the transfer.</p>
</div>


                </section>
                <section id="getNewProcess">
                            <input id="getNewProcess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">getNewProcess</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n"><a href="#Process">migrator_v2.Process</a></span>:</span></span>

                <label class="view-source-button" for="getNewProcess-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#getNewProcess"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="getNewProcess-219"><a href="#getNewProcess-219"><span class="linenos">219</span></a><span class="k">def</span> <span class="nf">getNewProcess</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Process</span><span class="p">:</span>
</span><span id="getNewProcess-220"><a href="#getNewProcess-220"><span class="linenos">220</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="getNewProcess-221"><a href="#getNewProcess-221"><span class="linenos">221</span></a><span class="sd">    Check specified directory for files of a process with finish flag.</span>
</span><span id="getNewProcess-222"><a href="#getNewProcess-222"><span class="linenos">222</span></a><span class="sd">    if files are found with the flag, create a process object and return it.</span>
</span><span id="getNewProcess-223"><a href="#getNewProcess-223"><span class="linenos">223</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="getNewProcess-224"><a href="#getNewProcess-224"><span class="linenos">224</span></a>    <span class="c1"># global DIRECTORY # Not sure if I need this or not.</span>
</span><span id="getNewProcess-225"><a href="#getNewProcess-225"><span class="linenos">225</span></a>    <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="getNewProcess-226"><a href="#getNewProcess-226"><span class="linenos">226</span></a>
</span><span id="getNewProcess-227"><a href="#getNewProcess-227"><span class="linenos">227</span></a>    <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># TODO: change this to the directory that the process files are stored in using the commented out code below</span>
</span><span id="getNewProcess-228"><a href="#getNewProcess-228"><span class="linenos">228</span></a>
</span><span id="getNewProcess-229"><a href="#getNewProcess-229"><span class="linenos">229</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/startflag.txt&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/pi/cpflag.txt&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># dont need to look for the folder, we can check for the flag directly</span>
</span><span id="getNewProcess-230"><a href="#getNewProcess-230"><span class="linenos">230</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="getNewProcess-231"><a href="#getNewProcess-231"><span class="linenos">231</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flag File Found, creating process&quot;</span><span class="p">)</span>
</span><span id="getNewProcess-232"><a href="#getNewProcess-232"><span class="linenos">232</span></a>    <span class="k">return</span> <span class="n">Process</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">aliasIP</span><span class="o">=</span><span class="n">IPv4Address</span><span class="p">(</span><span class="s2">&quot;192.168.137.3&quot;</span><span class="p">))</span>  <span class="c1"># TODO: change the IP address to a new IP for the process</span>
</span><span id="getNewProcess-233"><a href="#getNewProcess-233"><span class="linenos">233</span></a>
</span><span id="getNewProcess-234"><a href="#getNewProcess-234"><span class="linenos">234</span></a>    <span class="c1"># # received is the name of the directory that contains the process files</span>
</span><span id="getNewProcess-235"><a href="#getNewProcess-235"><span class="linenos">235</span></a>    <span class="c1"># received = next(iter(os.listdir(DIRECTORY)), None) # this will return the first item in the list, or None if the list is empty</span>
</span><span id="getNewProcess-236"><a href="#getNewProcess-236"><span class="linenos">236</span></a>    <span class="c1"># if received == None: return None</span>
</span><span id="getNewProcess-237"><a href="#getNewProcess-237"><span class="linenos">237</span></a>    <span class="c1"># if os.path.exists(os.path.join(DIRECTORY + received, &quot;FLAG.TXT&quot;)) == False: return None</span>
</span><span id="getNewProcess-238"><a href="#getNewProcess-238"><span class="linenos">238</span></a>    <span class="c1"># return Process(received)</span>
</span></pre></div>


            <div class="docstring"><p>Check specified directory for files of a process with finish flag.
if files are found with the flag, create a process object and return it.</p>
</div>


                </section>
                <section id="checkpointAndMigrateProcessToNode">
                            <input id="checkpointAndMigrateProcessToNode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">checkpointAndMigrateProcessToNode</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">proc</span><span class="p">:</span> <span class="n"><a href="#Process">migrator_v2.Process</a></span>, </span><span class="param"><span class="n">receivingIP</span><span class="p">:</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="checkpointAndMigrateProcessToNode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#checkpointAndMigrateProcessToNode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="checkpointAndMigrateProcessToNode-241"><a href="#checkpointAndMigrateProcessToNode-241"><span class="linenos">241</span></a><span class="k">def</span> <span class="nf">checkpointAndMigrateProcessToNode</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">Process</span><span class="p">,</span> <span class="n">receivingIP</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">):</span>
</span><span id="checkpointAndMigrateProcessToNode-242"><a href="#checkpointAndMigrateProcessToNode-242"><span class="linenos">242</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="checkpointAndMigrateProcessToNode-243"><a href="#checkpointAndMigrateProcessToNode-243"><span class="linenos">243</span></a><span class="sd">    Handle checkpointing and migration</span>
</span><span id="checkpointAndMigrateProcessToNode-244"><a href="#checkpointAndMigrateProcessToNode-244"><span class="linenos">244</span></a><span class="sd">    1. Checkpoint process</span>
</span><span id="checkpointAndMigrateProcessToNode-245"><a href="#checkpointAndMigrateProcessToNode-245"><span class="linenos">245</span></a><span class="sd">    2. confirm node is available and ready to receive process</span>
</span><span id="checkpointAndMigrateProcessToNode-246"><a href="#checkpointAndMigrateProcessToNode-246"><span class="linenos">246</span></a><span class="sd">    3. remove IP alias from current node</span>
</span><span id="checkpointAndMigrateProcessToNode-247"><a href="#checkpointAndMigrateProcessToNode-247"><span class="linenos">247</span></a><span class="sd">    4. rsync process directory to receiving node</span>
</span><span id="checkpointAndMigrateProcessToNode-248"><a href="#checkpointAndMigrateProcessToNode-248"><span class="linenos">248</span></a><span class="sd">    5. Send finish flag to node</span>
</span><span id="checkpointAndMigrateProcessToNode-249"><a href="#checkpointAndMigrateProcessToNode-249"><span class="linenos">249</span></a><span class="sd">    6. Delete process and supporting files on current node</span>
</span><span id="checkpointAndMigrateProcessToNode-250"><a href="#checkpointAndMigrateProcessToNode-250"><span class="linenos">250</span></a><span class="sd">    7. Display message with timing information for each step as a bar graph</span>
</span><span id="checkpointAndMigrateProcessToNode-251"><a href="#checkpointAndMigrateProcessToNode-251"><span class="linenos">251</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="checkpointAndMigrateProcessToNode-252"><a href="#checkpointAndMigrateProcessToNode-252"><span class="linenos">252</span></a>    <span class="n">start_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-253"><a href="#checkpointAndMigrateProcessToNode-253"><span class="linenos">253</span></a>    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="checkpointAndMigrateProcessToNode-254"><a href="#checkpointAndMigrateProcessToNode-254"><span class="linenos">254</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to checkpoint process, dumping failed&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-255"><a href="#checkpointAndMigrateProcessToNode-255"><span class="linenos">255</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process dumped successfully&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-256"><a href="#checkpointAndMigrateProcessToNode-256"><span class="linenos">256</span></a>    <span class="n">dump_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-257"><a href="#checkpointAndMigrateProcessToNode-257"><span class="linenos">257</span></a>
</span><span id="checkpointAndMigrateProcessToNode-258"><a href="#checkpointAndMigrateProcessToNode-258"><span class="linenos">258</span></a>    <span class="c1"># if confirmNodeAvailable(receivingIP) == False:</span>
</span><span id="checkpointAndMigrateProcessToNode-259"><a href="#checkpointAndMigrateProcessToNode-259"><span class="linenos">259</span></a>    <span class="c1">#     raise Exception(&quot;Receiving node is not responding/available&quot;)</span>
</span><span id="checkpointAndMigrateProcessToNode-260"><a href="#checkpointAndMigrateProcessToNode-260"><span class="linenos">260</span></a>    <span class="c1"># print(f&quot;Confirmed node at {receivingIP} is available&quot;)</span>
</span><span id="checkpointAndMigrateProcessToNode-261"><a href="#checkpointAndMigrateProcessToNode-261"><span class="linenos">261</span></a>    <span class="c1"># confirm_time_ms = int(time.time()*1000)</span>
</span><span id="checkpointAndMigrateProcessToNode-262"><a href="#checkpointAndMigrateProcessToNode-262"><span class="linenos">262</span></a>
</span><span id="checkpointAndMigrateProcessToNode-263"><a href="#checkpointAndMigrateProcessToNode-263"><span class="linenos">263</span></a>    <span class="k">if</span> <span class="n">IPalias</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">aliasIP</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="checkpointAndMigrateProcessToNode-264"><a href="#checkpointAndMigrateProcessToNode-264"><span class="linenos">264</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to remove IP alias from current node, new node will not be able to run process&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-265"><a href="#checkpointAndMigrateProcessToNode-265"><span class="linenos">265</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IP alias removed from current node&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-266"><a href="#checkpointAndMigrateProcessToNode-266"><span class="linenos">266</span></a>    <span class="n">alias_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-267"><a href="#checkpointAndMigrateProcessToNode-267"><span class="linenos">267</span></a>
</span><span id="checkpointAndMigrateProcessToNode-268"><a href="#checkpointAndMigrateProcessToNode-268"><span class="linenos">268</span></a>    <span class="k">if</span> <span class="n">receivingIP</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="checkpointAndMigrateProcessToNode-269"><a href="#checkpointAndMigrateProcessToNode-269"><span class="linenos">269</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch /home/pi/cpflag.txt&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-270"><a href="#checkpointAndMigrateProcessToNode-270"><span class="linenos">270</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="checkpointAndMigrateProcessToNode-271"><a href="#checkpointAndMigrateProcessToNode-271"><span class="linenos">271</span></a>
</span><span id="checkpointAndMigrateProcessToNode-272"><a href="#checkpointAndMigrateProcessToNode-272"><span class="linenos">272</span></a>    <span class="k">if</span> <span class="n">rsyncProcessToNode</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="n">receivingIP</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="checkpointAndMigrateProcessToNode-273"><a href="#checkpointAndMigrateProcessToNode-273"><span class="linenos">273</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to rsync process to receiving node, process may be incomplete&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-274"><a href="#checkpointAndMigrateProcessToNode-274"><span class="linenos">274</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process rsynced to receiving node&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-275"><a href="#checkpointAndMigrateProcessToNode-275"><span class="linenos">275</span></a>    <span class="n">rsync_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-276"><a href="#checkpointAndMigrateProcessToNode-276"><span class="linenos">276</span></a>
</span><span id="checkpointAndMigrateProcessToNode-277"><a href="#checkpointAndMigrateProcessToNode-277"><span class="linenos">277</span></a>    <span class="k">if</span> <span class="n">sendFinishFlag</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="n">receivingIP</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">procName</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="checkpointAndMigrateProcessToNode-278"><a href="#checkpointAndMigrateProcessToNode-278"><span class="linenos">278</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to send finish flag to receiving node, process may be incomplete&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-279"><a href="#checkpointAndMigrateProcessToNode-279"><span class="linenos">279</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finish flag sent to receiving node&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-280"><a href="#checkpointAndMigrateProcessToNode-280"><span class="linenos">280</span></a>    <span class="n">flag_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-281"><a href="#checkpointAndMigrateProcessToNode-281"><span class="linenos">281</span></a>
</span><span id="checkpointAndMigrateProcessToNode-282"><a href="#checkpointAndMigrateProcessToNode-282"><span class="linenos">282</span></a>    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">deleteFromDisk</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>  
</span><span id="checkpointAndMigrateProcessToNode-283"><a href="#checkpointAndMigrateProcessToNode-283"><span class="linenos">283</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to delete process from disk, process might accidentally be run again&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-284"><a href="#checkpointAndMigrateProcessToNode-284"><span class="linenos">284</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Process deleted from disk&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-285"><a href="#checkpointAndMigrateProcessToNode-285"><span class="linenos">285</span></a>    <span class="n">delete_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-286"><a href="#checkpointAndMigrateProcessToNode-286"><span class="linenos">286</span></a>
</span><span id="checkpointAndMigrateProcessToNode-287"><a href="#checkpointAndMigrateProcessToNode-287"><span class="linenos">287</span></a>    <span class="n">bar_width</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="checkpointAndMigrateProcessToNode-288"><a href="#checkpointAndMigrateProcessToNode-288"><span class="linenos">288</span></a>
</span><span id="checkpointAndMigrateProcessToNode-289"><a href="#checkpointAndMigrateProcessToNode-289"><span class="linenos">289</span></a>    <span class="n">total_time_ms</span> <span class="o">=</span> <span class="n">delete_time_ms</span><span class="o">-</span><span class="n">start_time_ms</span>
</span><span id="checkpointAndMigrateProcessToNode-290"><a href="#checkpointAndMigrateProcessToNode-290"><span class="linenos">290</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/migrate_stats.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="checkpointAndMigrateProcessToNode-291"><a href="#checkpointAndMigrateProcessToNode-291"><span class="linenos">291</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-292"><a href="#checkpointAndMigrateProcessToNode-292"><span class="linenos">292</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Migration took total of </span><span class="si">{</span><span class="n">total_time_ms</span><span class="si">}</span><span class="s2"> ms</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-293"><a href="#checkpointAndMigrateProcessToNode-293"><span class="linenos">293</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Dumping&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dump_time_ms</span><span class="o">-</span><span class="n">start_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">dump_time_ms</span><span class="o">-</span><span class="n">start_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-294"><a href="#checkpointAndMigrateProcessToNode-294"><span class="linenos">294</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;IP alias (rem)&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">alias_time_ms</span><span class="o">-</span><span class="n">dump_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">alias_time_ms</span><span class="o">-</span><span class="n">dump_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-295"><a href="#checkpointAndMigrateProcessToNode-295"><span class="linenos">295</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Rsyncing&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rsync_time_ms</span><span class="o">-</span><span class="n">alias_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">rsync_time_ms</span><span class="o">-</span><span class="n">alias_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-296"><a href="#checkpointAndMigrateProcessToNode-296"><span class="linenos">296</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Finish flag&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">flag_time_ms</span><span class="o">-</span><span class="n">rsync_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">flag_time_ms</span><span class="o">-</span><span class="n">rsync_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-297"><a href="#checkpointAndMigrateProcessToNode-297"><span class="linenos">297</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Deleting&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">delete_time_ms</span><span class="o">-</span><span class="n">flag_time_ms</span><span class="si">:</span><span class="s2">2.0f</span><span class="si">}</span><span class="s2"> ms </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">delete_time_ms</span><span class="o">-</span><span class="n">flag_time_ms</span><span class="p">)</span><span class="o">/</span><span class="n">total_time_ms</span><span class="o">*</span><span class="n">bar_width</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="checkpointAndMigrateProcessToNode-298"><a href="#checkpointAndMigrateProcessToNode-298"><span class="linenos">298</span></a>
</span><span id="checkpointAndMigrateProcessToNode-299"><a href="#checkpointAndMigrateProcessToNode-299"><span class="linenos">299</span></a>    <span class="n">proc</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># remove the process from memory after it has been migrated</span>
</span><span id="checkpointAndMigrateProcessToNode-300"><a href="#checkpointAndMigrateProcessToNode-300"><span class="linenos">300</span></a>    <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Handle checkpointing and migration</p>

<ol>
<li>Checkpoint process</li>
<li>confirm node is available and ready to receive process</li>
<li>remove IP alias from current node</li>
<li>rsync process directory to receiving node</li>
<li>Send finish flag to node</li>
<li>Delete process and supporting files on current node</li>
<li>Display message with timing information for each step as a bar graph</li>
</ol>
</div>


                </section>
                <section id="rsyncProcessToNode">
                            <input id="rsyncProcessToNode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rsyncProcessToNode</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">proc</span><span class="p">:</span> <span class="n"><a href="#Process">migrator_v2.Process</a></span>,</span><span class="param">	<span class="n">ip</span><span class="p">:</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span>,</span><span class="param">	<span class="n">password</span><span class="o">=</span><span class="s1">&#39;pi&#39;</span>,</span><span class="param">	<span class="n">username</span><span class="o">=</span><span class="s1">&#39;pi&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rsyncProcessToNode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rsyncProcessToNode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rsyncProcessToNode-303"><a href="#rsyncProcessToNode-303"><span class="linenos">303</span></a><span class="k">def</span> <span class="nf">rsyncProcessToNode</span><span class="p">(</span><span class="n">proc</span><span class="p">:</span> <span class="n">Process</span><span class="p">,</span> <span class="n">ip</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">):</span>
</span><span id="rsyncProcessToNode-304"><a href="#rsyncProcessToNode-304"><span class="linenos">304</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;rsync/scp dumped files to receiving node&quot;&quot;&quot;</span>
</span><span id="rsyncProcessToNode-305"><a href="#rsyncProcessToNode-305"><span class="linenos">305</span></a>    <span class="c1"># spawn rsync -avz /home/pi/{proc.getDirectory()} pi@{ip}:{DIRECTORY}</span>
</span><span id="rsyncProcessToNode-306"><a href="#rsyncProcessToNode-306"><span class="linenos">306</span></a>    <span class="n">procname</span> <span class="o">=</span> <span class="s2">&quot;videoboard&quot;</span>
</span><span id="rsyncProcessToNode-307"><a href="#rsyncProcessToNode-307"><span class="linenos">307</span></a>
</span><span id="rsyncProcessToNode-308"><a href="#rsyncProcessToNode-308"><span class="linenos">308</span></a>    <span class="n">ssh_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;sudo scp -r /home/pi/</span><span class="si">{</span><span class="n">procname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">:/home/pi/&#39;</span>
</span><span id="rsyncProcessToNode-309"><a href="#rsyncProcessToNode-309"><span class="linenos">309</span></a>    <span class="n">child</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="rsyncProcessToNode-310"><a href="#rsyncProcessToNode-310"><span class="linenos">310</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&#39;s password: &quot;</span><span class="p">])</span>
</span><span id="rsyncProcessToNode-311"><a href="#rsyncProcessToNode-311"><span class="linenos">311</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="rsyncProcessToNode-312"><a href="#rsyncProcessToNode-312"><span class="linenos">312</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
</span><span id="rsyncProcessToNode-313"><a href="#rsyncProcessToNode-313"><span class="linenos">313</span></a>    <span class="n">child</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="rsyncProcessToNode-314"><a href="#rsyncProcessToNode-314"><span class="linenos">314</span></a>    <span class="k">return</span> <span class="n">child</span><span class="o">.</span><span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>rsync/scp dumped files to receiving node</p>
</div>


                </section>
                <section id="IPalias">
                            <input id="IPalias-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">IPalias</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">address</span><span class="p">:</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span>, </span><span class="param"><span class="n">add</span><span class="p">:</span> <span class="nb">bool</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="IPalias-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IPalias"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IPalias-330"><a href="#IPalias-330"><span class="linenos">330</span></a><span class="k">def</span> <span class="nf">IPalias</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">,</span> <span class="n">add</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="IPalias-331"><a href="#IPalias-331"><span class="linenos">331</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle IP alias to current node. set add to true to add alias, and vice versa&quot;&quot;&quot;</span>
</span><span id="IPalias-332"><a href="#IPalias-332"><span class="linenos">332</span></a>    <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
</span><span id="IPalias-333"><a href="#IPalias-333"><span class="linenos">333</span></a>        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ip addr add </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">/24 dev eth0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="IPalias-334"><a href="#IPalias-334"><span class="linenos">334</span></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ip addr del </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">/24 dev eth0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Handle IP alias to current node. set add to true to add alias, and vice versa</p>
</div>


                </section>
                <section id="findAvailableNode">
                            <input id="findAvailableNode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">findAvailableNode</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span>:</span></span>

                <label class="view-source-button" for="findAvailableNode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#findAvailableNode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="findAvailableNode-337"><a href="#findAvailableNode-337"><span class="linenos">337</span></a><span class="k">def</span> <span class="nf">findAvailableNode</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">IPv4Address</span><span class="p">:</span>
</span><span id="findAvailableNode-338"><a href="#findAvailableNode-338"><span class="linenos">338</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find an available node to migrate to&quot;&quot;&quot;</span>
</span><span id="findAvailableNode-339"><a href="#findAvailableNode-339"><span class="linenos">339</span></a>    <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="findAvailableNode-340"><a href="#findAvailableNode-340"><span class="linenos">340</span></a>    <span class="k">for</span> <span class="n">packet</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">uniqueOtherNodeStatuses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="findAvailableNode-341"><a href="#findAvailableNode-341"><span class="linenos">341</span></a>        <span class="k">if</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>  <span class="c1"># found an available node</span>
</span><span id="findAvailableNode-342"><a href="#findAvailableNode-342"><span class="linenos">342</span></a>            <span class="n">available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">])</span>
</span><span id="findAvailableNode-343"><a href="#findAvailableNode-343"><span class="linenos">343</span></a>
</span><span id="findAvailableNode-344"><a href="#findAvailableNode-344"><span class="linenos">344</span></a>    <span class="c1"># TODO: Possible comparison for other factors like time, weather, etc.. here. For now, just return the first available node</span>
</span><span id="findAvailableNode-345"><a href="#findAvailableNode-345"><span class="linenos">345</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="findAvailableNode-346"><a href="#findAvailableNode-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">available</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="findAvailableNode-347"><a href="#findAvailableNode-347"><span class="linenos">347</span></a>    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Find an available node to migrate to</p>
</div>


                </section>
                <section id="confirmNodeAvailable">
                            <input id="confirmNodeAvailable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">confirmNodeAvailable</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">ip</span><span class="p">:</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Address</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="confirmNodeAvailable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#confirmNodeAvailable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="confirmNodeAvailable-350"><a href="#confirmNodeAvailable-350"><span class="linenos">350</span></a><span class="k">def</span> <span class="nf">confirmNodeAvailable</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="n">IPv4Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="confirmNodeAvailable-351"><a href="#confirmNodeAvailable-351"><span class="linenos">351</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Confirm that the node is available to receive a process by waiting for a new packet from the node&quot;&quot;&quot;</span>
</span><span id="confirmNodeAvailable-352"><a href="#confirmNodeAvailable-352"><span class="linenos">352</span></a>    <span class="n">last_time</span> <span class="o">=</span> <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="confirmNodeAvailable-353"><a href="#confirmNodeAvailable-353"><span class="linenos">353</span></a>    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">last_time</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># wait maximum 10 seconds for a new packet from the node</span>
</span><span id="confirmNodeAvailable-354"><a href="#confirmNodeAvailable-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">last_time</span><span class="p">:</span>
</span><span id="confirmNodeAvailable-355"><a href="#confirmNodeAvailable-355"><span class="linenos">355</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="confirmNodeAvailable-356"><a href="#confirmNodeAvailable-356"><span class="linenos">356</span></a>    <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># timed out</span>
</span></pre></div>


            <div class="docstring"><p>Confirm that the node is available to receive a process by waiting for a new packet from the node</p>
</div>


                </section>
                <section id="MainFSM">
                            <input id="MainFSM-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">MainFSM</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">process</span><span class="p">:</span> <span class="n"><a href="#Process">migrator_v2.Process</a></span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MainFSM-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MainFSM"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MainFSM-359"><a href="#MainFSM-359"><span class="linenos">359</span></a><span class="k">def</span> <span class="nf">MainFSM</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">Process</span><span class="p">):</span>
</span><span id="MainFSM-360"><a href="#MainFSM-360"><span class="linenos">360</span></a>    <span class="k">global</span> <span class="n">selfState</span>
</span><span id="MainFSM-361"><a href="#MainFSM-361"><span class="linenos">361</span></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># make sure it doesnt hog the CPU</span>
</span><span id="MainFSM-362"><a href="#MainFSM-362"><span class="linenos">362</span></a>
</span><span id="MainFSM-363"><a href="#MainFSM-363"><span class="linenos">363</span></a>    <span class="k">if</span> <span class="n">useADC</span><span class="p">:</span> 
</span><span id="MainFSM-364"><a href="#MainFSM-364"><span class="linenos">364</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="mi">55</span><span class="o">*</span><span class="n">voltage</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="si">:</span><span class="s2">=.5f</span><span class="si">}</span><span class="s2">, state=</span><span class="si">{</span><span class="n">selfState</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Press Ctrl-C to exit&quot;</span><span class="p">)</span>
</span><span id="MainFSM-365"><a href="#MainFSM-365"><span class="linenos">365</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="MainFSM-366"><a href="#MainFSM-366"><span class="linenos">366</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ADC READING DISABLED, state=</span><span class="si">{</span><span class="n">selfState</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Press Ctrl-C to exit&quot;</span><span class="p">)</span>
</span><span id="MainFSM-367"><a href="#MainFSM-367"><span class="linenos">367</span></a>
</span><span id="MainFSM-368"><a href="#MainFSM-368"><span class="linenos">368</span></a>
</span><span id="MainFSM-369"><a href="#MainFSM-369"><span class="linenos">369</span></a>    <span class="c1"># ------------------ Change State ------------------</span>
</span><span id="MainFSM-370"><a href="#MainFSM-370"><span class="linenos">370</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span><span class="p">:</span>
</span><span id="MainFSM-371"><a href="#MainFSM-371"><span class="linenos">371</span></a>        <span class="k">if</span> <span class="n">isLossOfPower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">getMigrateCMD</span><span class="p">():</span>
</span><span id="MainFSM-372"><a href="#MainFSM-372"><span class="linenos">372</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">MIGRATING</span>
</span><span id="MainFSM-373"><a href="#MainFSM-373"><span class="linenos">373</span></a>        <span class="k">elif</span> <span class="n">isLossOfPower</span><span class="p">(</span><span class="n">vThresh</span><span class="o">=</span><span class="mf">4.0</span><span class="p">):</span>
</span><span id="MainFSM-374"><a href="#MainFSM-374"><span class="linenos">374</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span>
</span><span id="MainFSM-375"><a href="#MainFSM-375"><span class="linenos">375</span></a>
</span><span id="MainFSM-376"><a href="#MainFSM-376"><span class="linenos">376</span></a>    <span class="c1"># ------------------ Change LEDs ------------------</span>
</span><span id="MainFSM-377"><a href="#MainFSM-377"><span class="linenos">377</span></a>    
</span><span id="MainFSM-378"><a href="#MainFSM-378"><span class="linenos">378</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
</span><span id="MainFSM-379"><a href="#MainFSM-379"><span class="linenos">379</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MainFSM-380"><a href="#MainFSM-380"><span class="linenos">380</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-381"><a href="#MainFSM-381"><span class="linenos">381</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-382"><a href="#MainFSM-382"><span class="linenos">382</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-383"><a href="#MainFSM-383"><span class="linenos">383</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">BUSY</span><span class="p">:</span>
</span><span id="MainFSM-384"><a href="#MainFSM-384"><span class="linenos">384</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MainFSM-385"><a href="#MainFSM-385"><span class="linenos">385</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-386"><a href="#MainFSM-386"><span class="linenos">386</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-387"><a href="#MainFSM-387"><span class="linenos">387</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-388"><a href="#MainFSM-388"><span class="linenos">388</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">MIGRATING</span><span class="p">:</span>
</span><span id="MainFSM-389"><a href="#MainFSM-389"><span class="linenos">389</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MainFSM-390"><a href="#MainFSM-390"><span class="linenos">390</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-391"><a href="#MainFSM-391"><span class="linenos">391</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-392"><a href="#MainFSM-392"><span class="linenos">392</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-393"><a href="#MainFSM-393"><span class="linenos">393</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span><span class="p">:</span>
</span><span id="MainFSM-394"><a href="#MainFSM-394"><span class="linenos">394</span></a>        <span class="n">led_27</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="MainFSM-395"><a href="#MainFSM-395"><span class="linenos">395</span></a>        <span class="n">led_4</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-396"><a href="#MainFSM-396"><span class="linenos">396</span></a>        <span class="n">led_17</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-397"><a href="#MainFSM-397"><span class="linenos">397</span></a>        <span class="n">led_22</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="MainFSM-398"><a href="#MainFSM-398"><span class="linenos">398</span></a>    
</span><span id="MainFSM-399"><a href="#MainFSM-399"><span class="linenos">399</span></a>    
</span><span id="MainFSM-400"><a href="#MainFSM-400"><span class="linenos">400</span></a>    <span class="c1"># TODO: improve the logic here, it is a bit messy. maybe use draw a state diagram to help visualize it</span>
</span><span id="MainFSM-401"><a href="#MainFSM-401"><span class="linenos">401</span></a>    <span class="c1"># ------------------ Execute State ------------------</span>
</span><span id="MainFSM-402"><a href="#MainFSM-402"><span class="linenos">402</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
</span><span id="MainFSM-403"><a href="#MainFSM-403"><span class="linenos">403</span></a>        <span class="n">process</span> <span class="o">=</span> <span class="n">getNewProcess</span><span class="p">()</span>
</span><span id="MainFSM-404"><a href="#MainFSM-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
</span><span id="MainFSM-405"><a href="#MainFSM-405"><span class="linenos">405</span></a>            <span class="n">IPalias</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">aliasIP</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="MainFSM-406"><a href="#MainFSM-406"><span class="linenos">406</span></a>            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="MainFSM-407"><a href="#MainFSM-407"><span class="linenos">407</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to start process thread. Process not started.&quot;</span><span class="p">)</span>
</span><span id="MainFSM-408"><a href="#MainFSM-408"><span class="linenos">408</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">BUSY</span>
</span><span id="MainFSM-409"><a href="#MainFSM-409"><span class="linenos">409</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MainFSM-410"><a href="#MainFSM-410"><span class="linenos">410</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/home/pi/force_shutdown.txt&quot;</span><span class="p">):</span>
</span><span id="MainFSM-411"><a href="#MainFSM-411"><span class="linenos">411</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/force_shutdown.txt&quot;</span><span class="p">)</span>
</span><span id="MainFSM-412"><a href="#MainFSM-412"><span class="linenos">412</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span>
</span><span id="MainFSM-413"><a href="#MainFSM-413"><span class="linenos">413</span></a>
</span><span id="MainFSM-414"><a href="#MainFSM-414"><span class="linenos">414</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">BUSY</span><span class="p">:</span>
</span><span id="MainFSM-415"><a href="#MainFSM-415"><span class="linenos">415</span></a>        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">procState</span> <span class="o">==</span> <span class="n">ProcessState</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">:</span>
</span><span id="MainFSM-416"><a href="#MainFSM-416"><span class="linenos">416</span></a>            <span class="c1"># sendProcessResultsToUser() # TODO: if we want to send the results back to the user, we can do that here</span>
</span><span id="MainFSM-417"><a href="#MainFSM-417"><span class="linenos">417</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span>
</span><span id="MainFSM-418"><a href="#MainFSM-418"><span class="linenos">418</span></a>
</span><span id="MainFSM-419"><a href="#MainFSM-419"><span class="linenos">419</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">MIGRATING</span><span class="p">:</span>
</span><span id="MainFSM-420"><a href="#MainFSM-420"><span class="linenos">420</span></a>        <span class="n">checkpointAndMigrateProcessToNode</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">findAvailableNode</span><span class="p">())</span>
</span><span id="MainFSM-421"><a href="#MainFSM-421"><span class="linenos">421</span></a>        <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span>
</span><span id="MainFSM-422"><a href="#MainFSM-422"><span class="linenos">422</span></a>
</span><span id="MainFSM-423"><a href="#MainFSM-423"><span class="linenos">423</span></a>    <span class="k">if</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">SHUTDOWN</span><span class="p">:</span>
</span><span id="MainFSM-424"><a href="#MainFSM-424"><span class="linenos">424</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;/home/pi/force_idle.txt&quot;</span><span class="p">):</span>
</span><span id="MainFSM-425"><a href="#MainFSM-425"><span class="linenos">425</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;sudo rm -rf /home/pi/force_idle.txt&quot;</span><span class="p">)</span>
</span><span id="MainFSM-426"><a href="#MainFSM-426"><span class="linenos">426</span></a>            <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NodeState</span><span class="o">.</span><span class="n">IDLE</span>
</span><span id="MainFSM-427"><a href="#MainFSM-427"><span class="linenos">427</span></a>
</span><span id="MainFSM-428"><a href="#MainFSM-428"><span class="linenos">428</span></a>    <span class="k">return</span> <span class="n">process</span>
</span></pre></div>


    

                </section>
                <section id="main">
                            <input id="main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">main</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="main-431"><a href="#main-431"><span class="linenos">431</span></a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span id="main-432"><a href="#main-432"><span class="linenos">432</span></a>    <span class="k">global</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">selfState</span>
</span><span id="main-433"><a href="#main-433"><span class="linenos">433</span></a>
</span><span id="main-434"><a href="#main-434"><span class="linenos">434</span></a>    <span class="c1"># get the ip address of the current host and store it in the selfState dictionary</span>
</span><span id="main-435"><a href="#main-435"><span class="linenos">435</span></a>    <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="s1">&#39;eth0&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span>
</span><span id="main-436"><a href="#main-436"><span class="linenos">436</span></a>
</span><span id="main-437"><a href="#main-437"><span class="linenos">437</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="main-438"><a href="#main-438"><span class="linenos">438</span></a>        <span class="c1"># https://gpiozero.readthedocs.io/en/stable/api_input.html#mcp3008</span>
</span><span id="main-439"><a href="#main-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="main-440"><a href="#main-440"><span class="linenos">440</span></a>            <span class="n">voltage</span> <span class="o">=</span> <span class="n">MCP3008</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">differential</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_voltage</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># single ended on channel 2</span>
</span><span id="main-441"><a href="#main-441"><span class="linenos">441</span></a>            <span class="n">current</span> <span class="o">=</span> <span class="n">MCP3008</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">differential</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_voltage</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># differential on channel 1 and 0, might need to change to pin 0 if output is inverted</span>
</span><span id="main-442"><a href="#main-442"><span class="linenos">442</span></a>        <span class="n">broadcaster</span> <span class="o">=</span> <span class="n">BroadcastSender</span><span class="p">()</span>  <span class="c1"># Start broadcast sender and receiver threads</span>
</span><span id="main-443"><a href="#main-443"><span class="linenos">443</span></a>        <span class="n">broadcaster</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="main-444"><a href="#main-444"><span class="linenos">444</span></a>        <span class="n">receiver</span> <span class="o">=</span> <span class="n">BroadcastReceiver</span><span class="p">()</span>
</span><span id="main-445"><a href="#main-445"><span class="linenos">445</span></a>        <span class="n">receiver</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="main-446"><a href="#main-446"><span class="linenos">446</span></a>        <span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="main-447"><a href="#main-447"><span class="linenos">447</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading voltage from pin 2, current from pin 0-1&quot;</span><span class="p">)</span>
</span><span id="main-448"><a href="#main-448"><span class="linenos">448</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="main-449"><a href="#main-449"><span class="linenos">449</span></a>            <span class="n">process</span> <span class="o">=</span> <span class="n">MainFSM</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>  <span class="c1"># Main FSM</span>
</span><span id="main-450"><a href="#main-450"><span class="linenos">450</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="main-451"><a href="#main-451"><span class="linenos">451</span></a>        <span class="n">broadcaster</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="main-452"><a href="#main-452"><span class="linenos">452</span></a>        <span class="n">broadcaster</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="main-453"><a href="#main-453"><span class="linenos">453</span></a>        <span class="n">receiver</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="main-454"><a href="#main-454"><span class="linenos">454</span></a>        <span class="n">receiver</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="main-455"><a href="#main-455"><span class="linenos">455</span></a>        <span class="c1"># for alias in selfState[&quot;ip_alias&quot;]:</span>
</span><span id="main-456"><a href="#main-456"><span class="linenos">456</span></a>        <span class="c1">#     IPalias(alias, False)</span>
</span><span id="main-457"><a href="#main-457"><span class="linenos">457</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting...&quot;</span><span class="p">)</span>
</span><span id="main-458"><a href="#main-458"><span class="linenos">458</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
</span><span id="main-459"><a href="#main-459"><span class="linenos">459</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span></pre></div>


    

                </section>
                <section id="BroadcastSender">
                            <input id="BroadcastSender-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BroadcastSender</span><wbr>(<span class="base">threading.Thread</span>):

                <label class="view-source-button" for="BroadcastSender-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastSender"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastSender-462"><a href="#BroadcastSender-462"><span class="linenos">462</span></a><span class="k">class</span> <span class="nc">BroadcastSender</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span id="BroadcastSender-463"><a href="#BroadcastSender-463"><span class="linenos">463</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="BroadcastSender-464"><a href="#BroadcastSender-464"><span class="linenos">464</span></a><span class="sd">    This class is used to create a thread that sends broadcast packets to other nodes. </span>
</span><span id="BroadcastSender-465"><a href="#BroadcastSender-465"><span class="linenos">465</span></a><span class="sd">    The packets contain the node&#39;s current state and IP address.</span>
</span><span id="BroadcastSender-466"><a href="#BroadcastSender-466"><span class="linenos">466</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BroadcastSender-467"><a href="#BroadcastSender-467"><span class="linenos">467</span></a>
</span><span id="BroadcastSender-468"><a href="#BroadcastSender-468"><span class="linenos">468</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">12345</span><span class="p">):</span>
</span><span id="BroadcastSender-469"><a href="#BroadcastSender-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span id="BroadcastSender-470"><a href="#BroadcastSender-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BroadcastSender-471"><a href="#BroadcastSender-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_delay</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="BroadcastSender-472"><a href="#BroadcastSender-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">baddress</span> <span class="o">=</span> <span class="n">address</span>
</span><span id="BroadcastSender-473"><a href="#BroadcastSender-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
</span><span id="BroadcastSender-474"><a href="#BroadcastSender-474"><span class="linenos">474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BroadcastSender-475"><a href="#BroadcastSender-475"><span class="linenos">475</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="BroadcastSender-476"><a href="#BroadcastSender-476"><span class="linenos">476</span></a>
</span><span id="BroadcastSender-477"><a href="#BroadcastSender-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastSender-478"><a href="#BroadcastSender-478"><span class="linenos">478</span></a>        <span class="k">global</span> <span class="n">selfState</span>
</span><span id="BroadcastSender-479"><a href="#BroadcastSender-479"><span class="linenos">479</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span id="BroadcastSender-480"><a href="#BroadcastSender-480"><span class="linenos">480</span></a>            <span class="c1"># ran = random.randrange(139, 143, 1)</span>
</span><span id="BroadcastSender-481"><a href="#BroadcastSender-481"><span class="linenos">481</span></a>            <span class="c1"># selfState[&quot;ip&quot;] = f&quot;192.168.137.{ran}&quot;  # this is temporary for testing. will be replaced with actual ip when we have a network-------------</span>
</span><span id="BroadcastSender-482"><a href="#BroadcastSender-482"><span class="linenos">482</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="BroadcastSender-483"><a href="#BroadcastSender-483"><span class="linenos">483</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BroadcastSender-484"><a href="#BroadcastSender-484"><span class="linenos">484</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BroadcastSender-485"><a href="#BroadcastSender-485"><span class="linenos">485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BroadcastSender-486"><a href="#BroadcastSender-486"><span class="linenos">486</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voltage</span><span class="o">.</span><span class="n">value</span>
</span><span id="BroadcastSender-487"><a href="#BroadcastSender-487"><span class="linenos">487</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">value</span>
</span><span id="BroadcastSender-488"><a href="#BroadcastSender-488"><span class="linenos">488</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selfState</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baddress</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
</span><span id="BroadcastSender-489"><a href="#BroadcastSender-489"><span class="linenos">489</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_delay</span><span class="p">)</span>
</span><span id="BroadcastSender-490"><a href="#BroadcastSender-490"><span class="linenos">490</span></a>            <span class="c1"># print(f&quot;broadcasting state {selfState[&#39;ip&#39;]}&quot;)</span>
</span><span id="BroadcastSender-491"><a href="#BroadcastSender-491"><span class="linenos">491</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closing Socket!&quot;</span><span class="p">)</span>
</span><span id="BroadcastSender-492"><a href="#BroadcastSender-492"><span class="linenos">492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="BroadcastSender-493"><a href="#BroadcastSender-493"><span class="linenos">493</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopped Broadcast!&quot;</span><span class="p">)</span>
</span><span id="BroadcastSender-494"><a href="#BroadcastSender-494"><span class="linenos">494</span></a>
</span><span id="BroadcastSender-495"><a href="#BroadcastSender-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastSender-496"><a href="#BroadcastSender-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>This class is used to create a thread that sends broadcast packets to other nodes. 
The packets contain the node's current state and IP address.</p>
</div>


                            <div id="BroadcastSender.__init__" class="classattr">
                                        <input id="BroadcastSender.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">BroadcastSender</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">address</span><span class="o">=</span><span class="s1">&#39;255.255.255.255&#39;</span>, </span><span class="param"><span class="n">port</span><span class="o">=</span><span class="mi">12345</span></span>)</span>

                <label class="view-source-button" for="BroadcastSender.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastSender.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastSender.__init__-468"><a href="#BroadcastSender.__init__-468"><span class="linenos">468</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;255.255.255.255&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">12345</span><span class="p">):</span>
</span><span id="BroadcastSender.__init__-469"><a href="#BroadcastSender.__init__-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span id="BroadcastSender.__init__-470"><a href="#BroadcastSender.__init__-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BroadcastSender.__init__-471"><a href="#BroadcastSender.__init__-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_delay</span> <span class="o">=</span> <span class="mf">0.2</span>
</span><span id="BroadcastSender.__init__-472"><a href="#BroadcastSender.__init__-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">baddress</span> <span class="o">=</span> <span class="n">address</span>
</span><span id="BroadcastSender.__init__-473"><a href="#BroadcastSender.__init__-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
</span><span id="BroadcastSender.__init__-474"><a href="#BroadcastSender.__init__-474"><span class="linenos">474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BroadcastSender.__init__-475"><a href="#BroadcastSender.__init__-475"><span class="linenos">475</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>This constructor should always be called with keyword arguments. Arguments are:</p>

<p><em>group</em> should be None; reserved for future extension when a ThreadGroup
class is implemented.</p>

<p><em>target</em> is the callable object to be invoked by the run()
method. Defaults to None, meaning nothing is called.</p>

<p><em>name</em> is the thread name. By default, a unique name is constructed of
the form "Thread-N" where N is a small decimal number.</p>

<p><em>args</em> is a list or tuple of arguments for the target invocation. Defaults to ().</p>

<p><em>kwargs</em> is a dictionary of keyword arguments for the target
invocation. Defaults to {}.</p>

<p>If a subclass overrides the constructor, it must make sure to invoke
the base class constructor (Thread.__init__()) before doing anything
else to the thread.</p>
</div>


                            </div>
                            <div id="BroadcastSender.run" class="classattr">
                                        <input id="BroadcastSender.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BroadcastSender.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastSender.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastSender.run-477"><a href="#BroadcastSender.run-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastSender.run-478"><a href="#BroadcastSender.run-478"><span class="linenos">478</span></a>        <span class="k">global</span> <span class="n">selfState</span>
</span><span id="BroadcastSender.run-479"><a href="#BroadcastSender.run-479"><span class="linenos">479</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span id="BroadcastSender.run-480"><a href="#BroadcastSender.run-480"><span class="linenos">480</span></a>            <span class="c1"># ran = random.randrange(139, 143, 1)</span>
</span><span id="BroadcastSender.run-481"><a href="#BroadcastSender.run-481"><span class="linenos">481</span></a>            <span class="c1"># selfState[&quot;ip&quot;] = f&quot;192.168.137.{ran}&quot;  # this is temporary for testing. will be replaced with actual ip when we have a network-------------</span>
</span><span id="BroadcastSender.run-482"><a href="#BroadcastSender.run-482"><span class="linenos">482</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">useADC</span><span class="p">:</span>
</span><span id="BroadcastSender.run-483"><a href="#BroadcastSender.run-483"><span class="linenos">483</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BroadcastSender.run-484"><a href="#BroadcastSender.run-484"><span class="linenos">484</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BroadcastSender.run-485"><a href="#BroadcastSender.run-485"><span class="linenos">485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BroadcastSender.run-486"><a href="#BroadcastSender.run-486"><span class="linenos">486</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voltage</span><span class="o">.</span><span class="n">value</span>
</span><span id="BroadcastSender.run-487"><a href="#BroadcastSender.run-487"><span class="linenos">487</span></a>                <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">value</span>
</span><span id="BroadcastSender.run-488"><a href="#BroadcastSender.run-488"><span class="linenos">488</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selfState</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baddress</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
</span><span id="BroadcastSender.run-489"><a href="#BroadcastSender.run-489"><span class="linenos">489</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_delay</span><span class="p">)</span>
</span><span id="BroadcastSender.run-490"><a href="#BroadcastSender.run-490"><span class="linenos">490</span></a>            <span class="c1"># print(f&quot;broadcasting state {selfState[&#39;ip&#39;]}&quot;)</span>
</span><span id="BroadcastSender.run-491"><a href="#BroadcastSender.run-491"><span class="linenos">491</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closing Socket!&quot;</span><span class="p">)</span>
</span><span id="BroadcastSender.run-492"><a href="#BroadcastSender.run-492"><span class="linenos">492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="BroadcastSender.run-493"><a href="#BroadcastSender.run-493"><span class="linenos">493</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopped Broadcast!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Method representing the thread's activity.</p>

<p>You may override this method in a subclass. The standard run() method
invokes the callable object passed to the object's constructor as the
target argument, if any, with sequential and keyword arguments taken
from the args and kwargs arguments, respectively.</p>
</div>


                            </div>
                            <div id="BroadcastSender.stop" class="classattr">
                                        <input id="BroadcastSender.stop-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BroadcastSender.stop-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastSender.stop"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastSender.stop-495"><a href="#BroadcastSender.stop-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastSender.stop-496"><a href="#BroadcastSender.stop-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>threading.Thread</dt>
                                <dd id="BroadcastSender.start" class="function">start</dd>
                <dd id="BroadcastSender.join" class="function">join</dd>
                <dd id="BroadcastSender.name" class="variable">name</dd>
                <dd id="BroadcastSender.ident" class="variable">ident</dd>
                <dd id="BroadcastSender.is_alive" class="function">is_alive</dd>
                <dd id="BroadcastSender.daemon" class="variable">daemon</dd>
                <dd id="BroadcastSender.isDaemon" class="function">isDaemon</dd>
                <dd id="BroadcastSender.setDaemon" class="function">setDaemon</dd>
                <dd id="BroadcastSender.getName" class="function">getName</dd>
                <dd id="BroadcastSender.setName" class="function">setName</dd>
                <dd id="BroadcastSender.native_id" class="variable">native_id</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="BroadcastReceiver">
                            <input id="BroadcastReceiver-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BroadcastReceiver</span><wbr>(<span class="base">threading.Thread</span>):

                <label class="view-source-button" for="BroadcastReceiver-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastReceiver"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastReceiver-499"><a href="#BroadcastReceiver-499"><span class="linenos">499</span></a><span class="k">class</span> <span class="nc">BroadcastReceiver</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span id="BroadcastReceiver-500"><a href="#BroadcastReceiver-500"><span class="linenos">500</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;This class is used to listen for incoming broadcast status packets from the nodes so each node can know the status of the other nodes&quot;&quot;&quot;</span>
</span><span id="BroadcastReceiver-501"><a href="#BroadcastReceiver-501"><span class="linenos">501</span></a>
</span><span id="BroadcastReceiver-502"><a href="#BroadcastReceiver-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastReceiver-503"><a href="#BroadcastReceiver-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BroadcastReceiver-504"><a href="#BroadcastReceiver-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">listenPort</span> <span class="o">=</span> <span class="mi">12345</span>
</span><span id="BroadcastReceiver-505"><a href="#BroadcastReceiver-505"><span class="linenos">505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sockSize</span> <span class="o">=</span> <span class="mi">512</span>
</span><span id="BroadcastReceiver-506"><a href="#BroadcastReceiver-506"><span class="linenos">506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span id="BroadcastReceiver-507"><a href="#BroadcastReceiver-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BroadcastReceiver-508"><a href="#BroadcastReceiver-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Set a timeout so the socket doesn&#39;t block indefinitely when trying to receive data</span>
</span><span id="BroadcastReceiver-509"><a href="#BroadcastReceiver-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listenPort</span><span class="p">))</span>  <span class="c1"># Listen on all interfaces on port 12345 for broadcast packets</span>
</span><span id="BroadcastReceiver-510"><a href="#BroadcastReceiver-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span> <span class="o">=</span> <span class="mi">8</span>         <span class="c1"># every 8 timeouts, clear the dictionary to remove old nodes</span>
</span><span id="BroadcastReceiver-511"><a href="#BroadcastReceiver-511"><span class="linenos">511</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="BroadcastReceiver-512"><a href="#BroadcastReceiver-512"><span class="linenos">512</span></a>
</span><span id="BroadcastReceiver-513"><a href="#BroadcastReceiver-513"><span class="linenos">513</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastReceiver-514"><a href="#BroadcastReceiver-514"><span class="linenos">514</span></a>        <span class="k">global</span> <span class="n">uniqueOtherNodeStatuses</span>
</span><span id="BroadcastReceiver-515"><a href="#BroadcastReceiver-515"><span class="linenos">515</span></a>
</span><span id="BroadcastReceiver-516"><a href="#BroadcastReceiver-516"><span class="linenos">516</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span id="BroadcastReceiver-517"><a href="#BroadcastReceiver-517"><span class="linenos">517</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="BroadcastReceiver-518"><a href="#BroadcastReceiver-518"><span class="linenos">518</span></a>                <span class="n">packet</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockSize</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="BroadcastReceiver-519"><a href="#BroadcastReceiver-519"><span class="linenos">519</span></a>                <span class="k">if</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]:</span>                              <span class="c1"># If the packet is not from this node</span>
</span><span id="BroadcastReceiver-520"><a href="#BroadcastReceiver-520"><span class="linenos">520</span></a>                    <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span id="BroadcastReceiver-521"><a href="#BroadcastReceiver-521"><span class="linenos">521</span></a>            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>  <span class="c1"># TODO: This timout does not work since the socket will receive its own broadcast packets</span>
</span><span id="BroadcastReceiver-522"><a href="#BroadcastReceiver-522"><span class="linenos">522</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BroadcastReceiver-523"><a href="#BroadcastReceiver-523"><span class="linenos">523</span></a>                    <span class="n">uniqueOtherNodeStatuses</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># If we don&#39;t receive anything within a period, clear</span>
</span><span id="BroadcastReceiver-524"><a href="#BroadcastReceiver-524"><span class="linenos">524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="BroadcastReceiver-525"><a href="#BroadcastReceiver-525"><span class="linenos">525</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>                    <span class="c1"># If we receive any exception, just print it and continue</span>
</span><span id="BroadcastReceiver-526"><a href="#BroadcastReceiver-526"><span class="linenos">526</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="BroadcastReceiver-527"><a href="#BroadcastReceiver-527"><span class="linenos">527</span></a>
</span><span id="BroadcastReceiver-528"><a href="#BroadcastReceiver-528"><span class="linenos">528</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastReceiver-529"><a href="#BroadcastReceiver-529"><span class="linenos">529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>This class is used to listen for incoming broadcast status packets from the nodes so each node can know the status of the other nodes</p>
</div>


                            <div id="BroadcastReceiver.__init__" class="classattr">
                                        <input id="BroadcastReceiver.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">BroadcastReceiver</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="BroadcastReceiver.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastReceiver.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastReceiver.__init__-502"><a href="#BroadcastReceiver.__init__-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastReceiver.__init__-503"><a href="#BroadcastReceiver.__init__-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BroadcastReceiver.__init__-504"><a href="#BroadcastReceiver.__init__-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">listenPort</span> <span class="o">=</span> <span class="mi">12345</span>
</span><span id="BroadcastReceiver.__init__-505"><a href="#BroadcastReceiver.__init__-505"><span class="linenos">505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sockSize</span> <span class="o">=</span> <span class="mi">512</span>
</span><span id="BroadcastReceiver.__init__-506"><a href="#BroadcastReceiver.__init__-506"><span class="linenos">506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span id="BroadcastReceiver.__init__-507"><a href="#BroadcastReceiver.__init__-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BroadcastReceiver.__init__-508"><a href="#BroadcastReceiver.__init__-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># Set a timeout so the socket doesn&#39;t block indefinitely when trying to receive data</span>
</span><span id="BroadcastReceiver.__init__-509"><a href="#BroadcastReceiver.__init__-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listenPort</span><span class="p">))</span>  <span class="c1"># Listen on all interfaces on port 12345 for broadcast packets</span>
</span><span id="BroadcastReceiver.__init__-510"><a href="#BroadcastReceiver.__init__-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span> <span class="o">=</span> <span class="mi">8</span>         <span class="c1"># every 8 timeouts, clear the dictionary to remove old nodes</span>
</span><span id="BroadcastReceiver.__init__-511"><a href="#BroadcastReceiver.__init__-511"><span class="linenos">511</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>This constructor should always be called with keyword arguments. Arguments are:</p>

<p><em>group</em> should be None; reserved for future extension when a ThreadGroup
class is implemented.</p>

<p><em>target</em> is the callable object to be invoked by the run()
method. Defaults to None, meaning nothing is called.</p>

<p><em>name</em> is the thread name. By default, a unique name is constructed of
the form "Thread-N" where N is a small decimal number.</p>

<p><em>args</em> is a list or tuple of arguments for the target invocation. Defaults to ().</p>

<p><em>kwargs</em> is a dictionary of keyword arguments for the target
invocation. Defaults to {}.</p>

<p>If a subclass overrides the constructor, it must make sure to invoke
the base class constructor (Thread.__init__()) before doing anything
else to the thread.</p>
</div>


                            </div>
                            <div id="BroadcastReceiver.run" class="classattr">
                                        <input id="BroadcastReceiver.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BroadcastReceiver.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastReceiver.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastReceiver.run-513"><a href="#BroadcastReceiver.run-513"><span class="linenos">513</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastReceiver.run-514"><a href="#BroadcastReceiver.run-514"><span class="linenos">514</span></a>        <span class="k">global</span> <span class="n">uniqueOtherNodeStatuses</span>
</span><span id="BroadcastReceiver.run-515"><a href="#BroadcastReceiver.run-515"><span class="linenos">515</span></a>
</span><span id="BroadcastReceiver.run-516"><a href="#BroadcastReceiver.run-516"><span class="linenos">516</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span id="BroadcastReceiver.run-517"><a href="#BroadcastReceiver.run-517"><span class="linenos">517</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="BroadcastReceiver.run-518"><a href="#BroadcastReceiver.run-518"><span class="linenos">518</span></a>                <span class="n">packet</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sockSize</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="BroadcastReceiver.run-519"><a href="#BroadcastReceiver.run-519"><span class="linenos">519</span></a>                <span class="k">if</span> <span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">selfState</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]:</span>                              <span class="c1"># If the packet is not from this node</span>
</span><span id="BroadcastReceiver.run-520"><a href="#BroadcastReceiver.run-520"><span class="linenos">520</span></a>                    <span class="n">uniqueOtherNodeStatuses</span><span class="p">[</span><span class="n">packet</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span id="BroadcastReceiver.run-521"><a href="#BroadcastReceiver.run-521"><span class="linenos">521</span></a>            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>  <span class="c1"># TODO: This timout does not work since the socket will receive its own broadcast packets</span>
</span><span id="BroadcastReceiver.run-522"><a href="#BroadcastReceiver.run-522"><span class="linenos">522</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BroadcastReceiver.run-523"><a href="#BroadcastReceiver.run-523"><span class="linenos">523</span></a>                    <span class="n">uniqueOtherNodeStatuses</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># If we don&#39;t receive anything within a period, clear</span>
</span><span id="BroadcastReceiver.run-524"><a href="#BroadcastReceiver.run-524"><span class="linenos">524</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">timeout_reset_counter</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="BroadcastReceiver.run-525"><a href="#BroadcastReceiver.run-525"><span class="linenos">525</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>                    <span class="c1"># If we receive any exception, just print it and continue</span>
</span><span id="BroadcastReceiver.run-526"><a href="#BroadcastReceiver.run-526"><span class="linenos">526</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Method representing the thread's activity.</p>

<p>You may override this method in a subclass. The standard run() method
invokes the callable object passed to the object's constructor as the
target argument, if any, with sequential and keyword arguments taken
from the args and kwargs arguments, respectively.</p>
</div>


                            </div>
                            <div id="BroadcastReceiver.stop" class="classattr">
                                        <input id="BroadcastReceiver.stop-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BroadcastReceiver.stop-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BroadcastReceiver.stop"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BroadcastReceiver.stop-528"><a href="#BroadcastReceiver.stop-528"><span class="linenos">528</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BroadcastReceiver.stop-529"><a href="#BroadcastReceiver.stop-529"><span class="linenos">529</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>threading.Thread</dt>
                                <dd id="BroadcastReceiver.start" class="function">start</dd>
                <dd id="BroadcastReceiver.join" class="function">join</dd>
                <dd id="BroadcastReceiver.name" class="variable">name</dd>
                <dd id="BroadcastReceiver.ident" class="variable">ident</dd>
                <dd id="BroadcastReceiver.is_alive" class="function">is_alive</dd>
                <dd id="BroadcastReceiver.daemon" class="variable">daemon</dd>
                <dd id="BroadcastReceiver.isDaemon" class="function">isDaemon</dd>
                <dd id="BroadcastReceiver.setDaemon" class="function">setDaemon</dd>
                <dd id="BroadcastReceiver.getName" class="function">getName</dd>
                <dd id="BroadcastReceiver.setName" class="function">setName</dd>
                <dd id="BroadcastReceiver.native_id" class="variable">native_id</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
</body>
</html>